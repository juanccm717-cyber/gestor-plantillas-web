{% extends "base.html" %}

{% block title %}Asistente Clínico{% endblock %}

{% block head %}
{{ super() }}
<style>
    .card-header .h3 { font-weight: 400; }
    .list-group-item {
        border-left: 4px solid transparent;
        padding-left: 1.25rem;
        transition: background-color 0.2s ease-in-out;
    }
    .list-group-item strong {
        display: block;
        margin-bottom: 0.25rem;
    }
    .medicamentos-header, .procedimientos-header, .insumos-header, .diagnostico-header {
        color: #fff;
        padding: 0.5rem 1.25rem;
        border-radius: 0.25rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    .medicamentos-header { background-color: #0d6efd; }
    .procedimientos-header { background-color: #198754; }
    .insumos-header { background-color: #fd7e14; }
    .diagnostico-header { background-color: #6c757d; }

    .list-group-item-medicamento { border-left-color: #0d6efd; }
    .list-group-item-procedimiento { border-left-color: #198754; }
    .list-group-item-insumo { border-left-color: #fd7e14; }
    .list-group-item-diagnostico { border-left-color: #6c757d; }

    .list-group-item-action.active {
        background-color: #e7f1ff;
        border-color: #0d6efd;
        color: #000;
        font-weight: 500;
    }
    .badge.bg-evidencia {
        font-weight: normal;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header bg-light text-center py-3">
                    <h2 class="h3 mb-0"><i class="bi bi-robot me-2 text-primary"></i>Asistente de Consulta Clínica</h2>
                    <p class="text-muted mb-0">Basado en Guías de Práctica Clínica Institucionales</p>
                </div>
                <div class="card-body p-4">
                    <label for="input-diagnostico" class="form-label fw-bold">1. Seleccione un Diagnóstico (CIE-10)</label>
                    <div class="input-group mb-3">
                        <input type="text" id="input-diagnostico" class="form-control form-control-lg" placeholder="Escriba el código o nombre del diagnóstico...">
                    </div>
                    
                    <hr class="my-4">

                    <h5 class="mb-3 fw-bold">2. Recomendaciones del Asistente</h5>
                    <div id="asistente-ia-sugerencias" class="mt-3">
                        <div class="alert alert-secondary text-center">
                            <i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico para ver las recomendaciones.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputDiagnostico = document.getElementById('input-diagnostico');
    const contenedorSugerencias = document.getElementById('asistente-ia-sugerencias');
    let allDiagnosticos = [];

    fetch('/api/get_all_diagnosticos')
        .then(response => response.json())
        .then(data => {
            allDiagnosticos = data.map(d => ({ label: `${d.codigo} - ${d.descripcion}`, value: d.codigo }));
            
            const dataList = document.createElement('datalist');
            dataList.id = 'diagnosticos-list';
            allDiagnosticos.forEach(d => {
                const option = document.createElement('option');
                option.value = d.label;
                dataList.appendChild(option);
            });
            document.body.appendChild(dataList);
            inputDiagnostico.setAttribute('list', 'diagnosticos-list');
        });

    function consultarAsistenteIA(codigoCIE10) {
        if (!codigoCIE10) {
            contenedorSugerencias.innerHTML = '<div class="alert alert-secondary text-center"><i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico válido.</div>';
            return;
        }
        contenedorSugerencias.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div><p class="mt-2">Consultando base de conocimiento...</p></div>';

        fetch(`/api/asistente_sugerencias?cie10=${codigoCIE10}`)
            .then(response => {
                if (!response.ok) throw new Error('No se encontraron recomendaciones para este diagnóstico en la base de conocimiento.');
                return response.json();
            })
            .then(data => {
                mostrarSugerencias(data);
            })
            .catch(error => {
                contenedorSugerencias.innerHTML = `<div class="alert alert-warning text-center"><i class="bi bi-exclamation-triangle me-2"></i>${error.message}</div>`;
            });
    }

    function renderizarTratamiento(tratamientoSugerido) {
        let tratamientoHtml = '';
        let hayTratamiento = false;

        if (tratamientoSugerido && tratamientoSugerido.medicamentos && tratamientoSugerido.medicamentos.length > 0) {
            hayTratamiento = true;
            tratamientoHtml += '<h6 class="medicamentos-header"><i class="bi bi-capsule-pill me-2"></i>Medicamentos Recomendados</h6><ul class="list-group list-group-flush">';
            tratamientoSugerido.medicamentos.sort((a, b) => a.prioridad - b.prioridad);
            tratamientoSugerido.medicamentos.forEach((med, index) => {
                const medId = `med-collapse-${Math.random().toString(36).substr(2, 9)}-${index}`;
                const codigoHtml = med.codigo_item ? `<span class="badge bg-secondary me-2">${med.codigo_item}</span>` : '';
                let detallesHtml = '';
                let evidenciaHtml = '';

                if (med.evidencia) {
                    evidenciaHtml = `<span class="badge bg-evidencia text-dark border border-secondary">Fuerza: ${med.evidencia.fuerza} / Calidad: ${med.evidencia.calidad}</span>`;
                }
                if (med.contraindicaciones_clave || med.efectos_adversos_comunes) {
                    detallesHtml += '<ul class="list-unstyled mt-2 mb-0 small">';
                    if (med.contraindicaciones_clave) detallesHtml += `<li><strong class="text-danger">Vigilar:</strong> ${med.contraindicaciones_clave.join(', ')}</li>`;
                    if (med.efectos_adversos_comunes) detallesHtml += `<li><strong class="text-warning">Efectos adversos:</strong> ${med.efectos_adversos_comunes.join(', ')}</li>`;
                    detallesHtml += '</ul>';
                }

                tratamientoHtml += `
                    <li class="list-group-item list-group-item-medicamento">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                ${codigoHtml}
                                <strong>${med.nombre}</strong>
                                <small class="text-muted d-block mt-1">${med.posologia}</small>
                            </div>
                            <div class="text-end ms-2" style="min-width: 150px;">
                                ${evidenciaHtml}
                                ${detallesHtml ? `<button class="btn btn-sm btn-link text-decoration-none p-0 mt-1" type="button" data-bs-toggle="collapse" data-bs-target="#${medId}" aria-expanded="false" aria-controls="${medId}">Ver detalles</button>` : ''}
                            </div>
                        </div>
                        ${detallesHtml ? `<div class="collapse mt-2" id="${medId}"><div class="p-2 bg-light rounded">${detallesHtml}</div></div>` : ''}
                    </li>`;
            });
            tratamientoHtml += '</ul>';
        }

        if (tratamientoSugerido && tratamientoSugerido.procedimientos && tratamientoSugerido.procedimientos.length > 0) {
            hayTratamiento = true;
            tratamientoHtml += '<h6 class="procedimientos-header"><i class="bi bi-heart-pulse me-2"></i>Procedimientos a Considerar</h6><ul class="list-group list-group-flush">';
            tratamientoSugerido.procedimientos.sort((a, b) => a.prioridad - b.prioridad);
            tratamientoSugerido.procedimientos.forEach(proc => {
                const evidenciaHtml = proc.evidencia ? `<span class="badge bg-evidencia text-dark border border-secondary float-end">Fuerza: ${proc.evidencia.fuerza} / Calidad: ${proc.evidencia.calidad}</span>` : '';
                tratamientoHtml += `<li class="list-group-item list-group-item-procedimiento"><div><strong>${proc.nombre}</strong>${evidenciaHtml}</div><small class="text-muted d-block">${proc.indicacion}</small></li>`;
            });
            tratamientoHtml += '</ul>';
        }
        
        return { html: tratamientoHtml, hayContenido: hayTratamiento };
    }

    function mostrarSugerencias(data) {
        let html = '';
        if (data.notas_clinicas) {
            html += `<div class="alert alert-info">${data.notas_clinicas}</div>`;
        }

        if (data.logica_adicional && data.logica_adicional.pregunta_contexto) {
            html += `<div class="card border-primary mt-4">
                        <div class="card-header bg-primary bg-opacity-10 border-primary">
                            <h6 class="mb-0">${data.logica_adicional.pregunta_contexto}</h6>
                        </div>
                        <div class="list-group list-group-flush">`;
            
            for (const key in data.logica_adicional.opciones) {
                html += `<button type="button" class="list-group-item list-group-item-action" 
                                 data-recomendacion="${encodeURIComponent(JSON.stringify(data.logica_adicional.opciones[key]))}">
                            ${key.replace(/_/g, ' ')}
                         </button>`;
            }
            html += `</div></div><div id="recomendacion-especifica" class="mt-3"></div>`;
        }

        if (data.criterios_diagnosticos && data.criterios_diagnosticos.criterios) {
            html += '<h6 class="diagnostico-header"><i class="bi bi-clipboard2-check me-2"></i>Criterios Diagnósticos</h6>';
            if(data.criterios_diagnosticos.nota) html += `<p class="text-muted">${data.criterios_diagnosticos.nota}</p>`;
            html += '<ul class="list-group list-group-flush">';
            data.criterios_diagnosticos.criterios.forEach(criterio => {
                html += `<li class="list-group-item list-group-item-diagnostico">${criterio}</li>`;
            });
            html += '</ul>';
        }

        const tratamientoRenderizado = renderizarTratamiento(data.tratamiento_sugerido);
        html += tratamientoRenderizado.html;

        if (!tratamientoRenderizado.hayContenido && !(data.logica_adicional && data.logica_adicional.pregunta_contexto)) {
             html += '<div class="alert alert-light mt-3 text-center">No hay sugerencias específicas de tratamiento en la base de conocimiento para este diagnóstico.</div>';
        }

        contenedorSugerencias.innerHTML = html;

        document.querySelectorAll('.list-group-item-action').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.list-group-item-action').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                const recomendacionData = JSON.parse(decodeURIComponent(this.dataset.recomendacion));
                let recomendacionHtml = `<div class="card bg-light border-primary shadow-sm"><div class="card-body">
                                            <p class="mb-1"><strong>Recomendación:</strong> ${recomendacionData.recomendacion_clave}</p>`;
                if(recomendacionData.meta_presion_arterial) recomendacionHtml += `<p class="mb-1"><small><strong>Meta de P.A.:</strong> ${recomendacionData.meta_presion_arterial}</small></p>`;
                if(recomendacionData.nota) recomendacionHtml += `<small class="text-muted">${recomendacionData.nota}</small>`;
                
                if (recomendacionData.tratamiento_adicional) {
                    const tratamientoAdicional = renderizarTratamiento(recomendacionData.tratamiento_adicional);
                    recomendacionHtml += `<hr>${tratamientoAdicional.html}`;
                }

                recomendacionHtml += `</div></div>`;

                document.getElementById('recomendacion-especifica').innerHTML = recomendacionHtml;
            });
        });
    }

    inputDiagnostico.addEventListener('input', function() {
        const valorInput = inputDiagnostico.value;
        const diagnosticoSeleccionado = allDiagnosticos.find(d => d.label === valorInput);
        
        if (diagnosticoSeleccionado) {
            consultarAsistenteIA(diagnosticoSeleccionado.value);
        }
    });
});
</script>
{% endblock %}
