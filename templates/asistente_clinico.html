{% extends "base.html" %}

{% block title %}Asistente Clínico{% endblock %}

{% block head %}
{{ super() }}
<style>
    .card-header .h3 { font-weight: 400; }
    .list-group-item {
        border-left: 4px solid transparent;
        padding-left: 1.25rem;
        transition: background-color 0.2s ease-in-out;
    }
    .list-group-item strong {
        display: block;
        margin-bottom: 0.25rem;
    }
    .medicamentos-header, .procedimientos-header, .insumos-header, .diagnostico-header {
        color: #fff;
        padding: 0.5rem 1.25rem;
        border-radius: 0.25rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    .medicamentos-header { background-color: #0d6efd; }
    .procedimientos-header { background-color: #198754; }
    .insumos-header { background-color: #fd7e14; }
    .diagnostico-header { background-color: #6c757d; }

    .list-group-item-medicamento { border-left-color: #0d6efd; }
    .list-group-item-procedimiento { border-left-color: #198754; }
    .list-group-item-insumo { border-left-color: #fd7e14; }
    .list-group-item-diagnostico { border-left-color: #6c757d; }

    .list-group-item-action.active {
        background-color: #e7f1ff;
        border-color: #0d6efd;
        color: #000;
        font-weight: 500;
    }
    .badge.bg-evidencia {
        font-weight: normal;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- SECCIÓN 1: CONFIGURACIÓN INICIAL (sin cambios) ---
    const inputDiagnostico = document.getElementById('input-diagnostico');
    const contenedorSugerencias = document.getElementById('asistente-ia-sugerencias');
    let allDiagnosticos = [];

    fetch('/api/get_all_diagnosticos')
        .then(response => response.json())
        .then(data => {
            allDiagnosticos = data.map(d => ({ label: `${d.codigo} - ${d.descripcion}`, value: d.codigo }));
            const dataList = document.createElement('datalist');
            dataList.id = 'diagnosticos-list';
            allDiagnosticos.forEach(d => {
                const option = document.createElement('option');
                option.value = d.label;
                dataList.appendChild(option);
            });
            document.body.appendChild(dataList);
            inputDiagnostico.setAttribute('list', 'diagnosticos-list');
        });

    // --- SECCIÓN 2: LÓGICA DE CONSULTA (sin cambios) ---
    function consultarAsistenteIA(textoInput) {
        const codigoCIE10 = textoInput.split(' - ')[0].trim();

        if (!codigoCIE10) {
            contenedorSugerencias.innerHTML = '<div class="alert alert-secondary text-center">Seleccione un diagnóstico válido.</div>';
            return;
        }
        contenedorSugerencias.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Consultando base de conocimiento...</p></div>';

        fetch(`/api/asistente_sugerencias?cie10=${codigoCIE10}`)
            .then(response => {
                if (!response.ok) throw new Error('No se encontraron recomendaciones para este diagnóstico.');
                return response.json();
            })
            .then(data => {
                // ¡AQUÍ ESTÁ LA MAGIA! Traducimos el formato antes de mostrar.
                const datosFormatoAntiguo = traducirAlFormatoV4_6(data);
                mostrarSugerencias(datosFormatoAntiguo); // Llamamos a tu función original
            })
            .catch(error => {
                contenedorSugerencias.innerHTML = `<div class="alert alert-warning text-center">${error.message}</div>`;
            });
    }

    // ==================================================================
    //      (¡NUEVO!) EL TRADUCTOR DE FORMATOS
    // ==================================================================
    function traducirAlFormatoV4_6(data) {
        // Objeto base con la estructura que tu frontend espera (v4.6)
        const resultado = {
            nombre_guia: data.nombre_guia,
            version: data.version_guia,
            fecha_publicacion: data.fecha_actualizacion,
            institucion: "EsSalud (IETSI)", // Valor por defecto
            poblacion_objetivo: null,
            diagnostico: {
                signos_sintomas: [],
                examenes_auxiliares: []
            },
            tratamiento_ambulatorio: {
                tratamientos_no_farmacologicos: [],
                primera_linea: { medicamentos: [] },
                alternativas: []
            },
            // ... puedes añadir más estructuras vacías si las necesitas
        };

        // Mapeamos las secciones del "Estándar Dorado" a la estructura v4.6
        if (data.secciones && data.secciones.length > 0) {
            data.secciones.forEach(seccion => {
                const titulo = seccion.titulo.toLowerCase();
                const contenido = seccion.contenido;

                // Lógica de mapeo simple basada en palabras clave en el título
                if (titulo.includes('diagnóstico')) {
                    resultado.diagnostico.examenes_auxiliares.push({
                        nombre: seccion.titulo,
                        recomendacion: contenido
                    });
                } else if (titulo.includes('tratamiento') || titulo.includes('manejo')) {
                     resultado.tratamiento_ambulatorio.primera_linea.medicamentos.push({
                        nombre: seccion.titulo,
                        dosis: contenido // Usamos el campo 'dosis' para mostrar el texto completo
                    });
                } else {
                    // Para cualquier otra sección, la ponemos como un tratamiento no farmacológico
                     resultado.tratamiento_ambulatorio.tratamientos_no_farmacologicos.push({
                        nombre: seccion.titulo,
                        recomendacion: contenido
                    });
                }
            });
        }
        
        return resultado;
    }


    // ==================================================================
    //      TU FUNCIÓN ORIGINAL `mostrarSugerencias` (SIN CAMBIOS)
    //      La dejamos intacta porque ahora recibe el formato que espera.
    // ==================================================================
    function mostrarSugerencias(data) {
        const renderCodigo = (codigo) => codigo ? `<span class="badge bg-dark me-2">${codigo}</span>` : '';

        let html = `
            <div class="card border-light-subtle shadow-sm">
                <div class="card-header bg-light-subtle">
                    <h5 class="mb-1">${data.nombre_guia || 'Guía sin nombre'}</h5>
                    <small class="text-muted">${data.institucion || ''} - ${data.version || ''} (${data.fecha_publicacion || 'N/A'})</small>
                </div>
                <div class="card-body">`;

        const renderPoblacion = (d) => d.poblacion_objetivo ? `<h6 class="mt-3"><i class="bi bi-people-fill text-primary me-2"></i>Población Objetivo</h6><p class="text-muted small">${d.poblacion_objetivo.descripcion}</p>` : '';
        
        const renderDiagnostico = (d) => {
            if (!d.diagnostico) return '';
            let content = `<h6 class="mt-4"><i class="bi bi-file-earmark-medical-fill text-info me-2"></i>Diagnóstico</h6>`;
            if (d.diagnostico.signos_sintomas && d.diagnostico.signos_sintomas.length > 0) content += `<p class="small"><strong>Signos/Síntomas:</strong> ${d.diagnostico.signos_sintomas.join(', ')}.</p>`;
            if (d.diagnostico.examenes_auxiliares && d.diagnostico.examenes_auxiliares.length > 0) {
                content += `<p class="small mt-2"><strong>Exámenes y Recomendaciones:</strong></p><ul class="small list-unstyled">`;
                d.diagnostico.examenes_auxiliares.forEach(e => {
                    content += `<li>${renderCodigo(e.codigo_proc)}<strong>${e.nombre}:</strong> ${e.recomendacion}</li>`;
                });
                content += `</ul>`;
            }
            return content;
        };

        const renderTratamientoAmbulatorio = (d) => {
            if (!d.tratamiento_ambulatorio) return '';
            const tto = d.tratamiento_ambulatorio;
            let content = '';

            if (tto.tratamientos_no_farmacologicos && tto.tratamientos_no_farmacologicos.length > 0) {
                content += `<h6>Recomendaciones Generales</h6><ul>`;
                tto.tratamientos_no_farmacologicos.forEach(t => { content += `<li class="small">${renderCodigo(t.codigo_proc)}<strong>${t.nombre}:</strong> ${t.recomendacion}</li>`; });
                content += `</ul>`;
            }
            
            const primeraLinea = tto.primera_linea_farmacologica || tto.primera_linea;
            if (primeraLinea && primeraLinea.medicamentos && primeraLinea.medicamentos.length > 0) {
                content += `<h6 class="mt-3">Tratamiento y Manejo Específico</h6><ul>`;
                primeraLinea.medicamentos.forEach(m => {
                    content += `<li class="small">${renderCodigo(m.codigo_item)}<strong>${m.nombre}:</strong> ${m.dosis || ''} ${m.frecuencia || ''} ${m.duracion_dias ? 'por ' + m.duracion_dias + ' días' : ''}.</li>`;
                });
                content += `</ul>`;
            }

            const alternativas = tto.alternativas_farmacologicas || tto.alternativas;
            if (alternativas && alternativas.length > 0) {
                content += `<h6 class="mt-3">Alternativas Farmacológicas</h6><ul>`;
                alternativas.forEach(a => {
                    content += `<li class="small">${renderCodigo(a.codigo_item)}<strong>Si el paciente presenta "${a.condicion}":</strong> Usar ${a.medicamento} (${a.dosis}).</li>`;
                });
                content += `</ul>`;
            }

            if (tto.tratamientos_no_recomendados && tto.tratamientos_no_recomendados.length > 0) {
                content += `<h6 class="mt-3 text-danger">Tratamientos NO Recomendados</h6><p class="small text-muted">${tto.tratamientos_no_recomendados.join(', ')}.</p>`;
            }

            return content ? `<h5 class="mt-4 mb-3 text-success"><i class="bi bi-house-heart-fill me-2"></i>Recomendaciones Clave</h5>${content}` : '';
        };

        // Dejamos las otras funciones de renderizado por si las necesitamos en el futuro
        const renderTratamientoHospitalario = (d) => { /* ...tu código original... */ return ''; };
        const renderManejoMedico = (d) => { /* ...tu código original... */ return ''; };
        const renderManejoIntervencionista = (d) => { /* ...tu código original... */ return ''; };

        html += renderPoblacion(data);
        html += renderDiagnostico(data);
        html += renderTratamientoAmbulatorio(data);
        html += renderTratamientoHospitalario(data);
        html += renderManejoMedico(data);
        html += renderManejoIntervencionista(data);
        
        html += `</div></div>`;
        contenedorSugerencias.innerHTML = html;
    }

    // --- SECCIÓN 3: EVENT LISTENER (sin cambios) ---
    inputDiagnostico.addEventListener('input', function() {
        consultarAsistenteIA(inputDiagnostico.value);
    });
});
</script>
{% endblock %}
