{% extends "base.html" %}

{% block title %}Asistente Clínico{% endblock %}

{% block head %}
{{ super() }}
<style>
    .card-header .h3 { font-weight: 400; }
    .list-group-item {
        border-left: 4px solid transparent;
        padding-left: 1.25rem;
        transition: background-color 0.2s ease-in-out;
    }
    .list-group-item strong {
        display: block;
        margin-bottom: 0.25rem;
    }
    .medicamentos-header, .procedimientos-header, .insumos-header, .diagnostico-header {
        color: #fff;
        padding: 0.5rem 1.25rem;
        border-radius: 0.25rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    .medicamentos-header { background-color: #0d6efd; }
    .procedimientos-header { background-color: #198754; }
    .insumos-header { background-color: #fd7e14; }
    .diagnostico-header { background-color: #6c757d; }

    .list-group-item-medicamento { border-left-color: #0d6efd; }
    .list-group-item-procedimiento { border-left-color: #198754; }
    .list-group-item-insumo { border-left-color: #fd7e14; }
    .list-group-item-diagnostico { border-left-color: #6c757d; }

    .list-group-item-action.active {
        background-color: #e7f1ff;
        border-color: #0d6efd;
        color: #000;
        font-weight: 500;
    }
    .badge.bg-evidencia {
        font-weight: normal;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header bg-light text-center py-3">
                    <h2 class="h3 mb-0"><i class="bi bi-robot me-2 text-primary"></i>Asistente de Consulta Clínica</h2>
                    <p class="text-muted mb-0">Basado en Guías de Práctica Clínica Institucionales</p>
                </div>
                <div class="card-body p-4">
                    <label for="input-diagnostico" class="form-label fw-bold">1. Seleccione un Diagnóstico (CIE-10)</label>
                    <div class="input-group mb-3">
                        <input type="text" id="input-diagnostico" class="form-control form-control-lg" placeholder="Escriba el código o nombre del diagnóstico...">
                    </div>
                    
                    <hr class="my-4">

                    <h5 class="mb-3 fw-bold">2. Recomendaciones del Asistente</h5>
                    <div id="asistente-ia-sugerencias" class="mt-3">
                        <div class="alert alert-secondary text-center">
                            <i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico para ver las recomendaciones.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- SECCIÓN 1: CONFIGURACIÓN INICIAL (sin cambios) ---
    const inputDiagnostico = document.getElementById('input-diagnostico');
    const contenedorSugerencias = document.getElementById('asistente-ia-sugerencias');
    let allDiagnosticos = [];

    fetch('/api/get_all_diagnosticos')
        .then(response => response.json())
        .then(data => {
            allDiagnosticos = data.map(d => ({ label: `${d.codigo} - ${d.descripcion}`, value: d.codigo }));
            const dataList = document.createElement('datalist');
            dataList.id = 'diagnosticos-list';
            allDiagnosticos.forEach(d => {
                const option = document.createElement('option');
                option.value = d.label;
                dataList.appendChild(option);
            });
            document.body.appendChild(dataList);
            inputDiagnostico.setAttribute('list', 'diagnosticos-list');
        });

    function consultarAsistenteIA(codigoCIE10) {
        if (!codigoCIE10) {
            contenedorSugerencias.innerHTML = '<div class="alert alert-secondary text-center">Seleccione un diagnóstico válido.</div>';
            return;
        }
        contenedorSugerencias.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Consultando base de conocimiento...</p></div>';

        fetch(`/api/asistente_sugerencias?cie10=${codigoCIE10}`)
            .then(response => {
                if (!response.ok) throw new Error('No se encontraron recomendaciones para este diagnóstico.');
                return response.json();
            })
            .then(data => {
                mostrarSugerencias(data);
            })
            .catch(error => {
                contenedorSugerencias.innerHTML = `<div class="alert alert-warning text-center">${error.message}</div>`;
            });
    }

    // ==================================================================
    //      RENDERIZADOR INTELIGENTE v4.4 (LA VERSIÓN DEFINITIVA)
    // ==================================================================
    function mostrarSugerencias(data) {
        const renderCodigo = (codigo) => codigo ? `<span class="badge bg-dark me-2">${codigo}</span>` : '';

        let html = `
            <div class="card border-light-subtle shadow-sm">
                <div class="card-header bg-light-subtle">
                    <h5 class="mb-1">${data.nombre_guia || 'Guía sin nombre'}</h5>
                    <small class="text-muted">${data.institucion || ''} - ${data.version || ''} (${data.fecha_publicacion || 'N/A'})</small>
                </div>
                <div class="card-body">`;

        // --- RENDERIZADORES DE SECCIÓN (MODULARES Y ADAPTATIVOS) ---

        const renderPoblacion = (d) => d.poblacion_objetivo ? `<h6 class="mt-3"><i class="bi bi-people-fill text-primary me-2"></i>Población Objetivo</h6><p class="text-muted small">${d.poblacion_objetivo.descripcion}</p>` : '';
        
        const renderDiagnostico = (d) => {
            if (!d.diagnostico) return '';
            let content = `<h6 class="mt-4"><i class="bi bi-file-earmark-medical-fill text-info me-2"></i>Diagnóstico</h6>`;
            if (d.diagnostico.signos_sintomas && d.diagnostico.signos_sintomas.length > 0) content += `<p class="small"><strong>Signos/Síntomas:</strong> ${d.diagnostico.signos_sintomas.join(', ')}.</p>`;
            if (d.diagnostico.examenes_auxiliares && d.diagnostico.examenes_auxiliares.length > 0) {
                content += `<p class="small mt-2"><strong>Exámenes Auxiliares:</strong></p><ul class="small list-unstyled">`;
                d.diagnostico.examenes_auxiliares.forEach(e => {
                    content += `<li>${renderCodigo(e.codigo_proc)}<strong>${e.nombre}:</strong> ${e.recomendacion}</li>`;
                });
                content += `</ul>`;
            }
            return content;
        };

        // ¡VERSIÓN FINAL! Comprueba cada sub-sección de forma independiente.
        const renderTratamientoAmbulatorio = (d) => {
            if (!d.tratamiento_ambulatorio) return '';
            
            const tto = d.tratamiento_ambulatorio;
            let content = '';

            if (tto.tratamientos_no_farmacologicos && tto.tratamientos_no_farmacologicos.length > 0) {
                content += `<h6>No Farmacológico</h6><ul>`;
                tto.tratamientos_no_farmacologicos.forEach(t => { content += `<li class="small"><strong>${t.nombre}:</strong> ${t.recomendacion}</li>`; });
                content += `</ul>`;
            }
            
            const primeraLinea = tto.primera_linea_farmacologica || tto.primera_linea;
            if (primeraLinea && primeraLinea.medicamentos) {
                content += `<h6 class="mt-3">1ª Línea Farmacológica</h6><ul>`;
                primeraLinea.medicamentos.forEach(m => {
                    content += `<li class="small">${renderCodigo(m.codigo_item)}<strong>${m.nombre}:</strong> ${m.dosis || ''} ${m.frecuencia || ''} ${m.duracion_dias ? 'por ' + m.duracion_dias + ' días' : ''}.</li>`;
                });
                content += `</ul>`;
            }

            const alternativas = tto.alternativas_farmacologicas || tto.alternativas;
            if (alternativas && alternativas.length > 0) {
                content += `<h6 class="mt-3">Alternativas Farmacológicas</h6><ul>`;
                alternativas.forEach(a => {
                    content += `<li class="small">${renderCodigo(a.codigo_item)}<strong>Si el paciente presenta "${a.condicion}":</strong> Usar ${a.medicamento} (${a.dosis}).</li>`;
                });
                content += `</ul>`;
            }

            if (tto.tratamientos_no_recomendados && tto.tratamientos_no_recomendados.length > 0) {
                content += `<h6 class="mt-3 text-danger">Tratamientos NO Recomendados</h6><p class="small text-muted">${tto.tratamientos_no_recomendados.join(', ')}.</p>`;
            }

            return content ? `<h5 class="mt-4 mb-3 text-success"><i class="bi bi-house-heart-fill me-2"></i>Tratamiento Ambulatorio</h5>${content}` : '';
        };

        const renderTratamientoHospitalario = (d) => {
            if (!d.tratamiento_hospitalario || !d.tratamiento_hospitalario.grupos_etarios) return '';
            let content = `<h5 class="mt-4 mb-3 text-danger"><i class="bi bi-hospital-fill me-2"></i>Tratamiento Hospitalario</h5>`;
            d.tratamiento_hospitalario.grupos_etarios.forEach(grupo => {
                content += `<div class="mb-3"><h6>Grupo: ${grupo.rango_edad}</h6>`;
                if (grupo.primera_linea) {
                    const tto = grupo.primera_linea;
                    let dosisStr = typeof tto.dosis === 'object' ? Object.entries(tto.dosis).map(([k,v]) => `${k}: ${v}`).join(', ') : tto.dosis;
                    content += `<p class="small"><strong>1ª Línea:</strong> ${renderCodigo(tto.codigo_item)}${tto.medicamento} (${dosisStr}).</p>`;
                }
                if (grupo.alternativas && grupo.alternativas.length > 0) {
                     content += `<ul>`;
                     grupo.alternativas.forEach(alt => {
                        let dosisAltStr = typeof alt.dosis === 'object' ? Object.entries(alt.dosis).map(([k,v]) => `${k}: ${v}`).join(', ') : alt.dosis;
                        content += `<li class="small"><strong>Alternativa (si presenta "${alt.condicion}"):</strong> Usar ${alt.medicamento} (${dosisAltStr}).</li>`;
                     });
                     content += `</ul>`;
                }
                content += `</div>`;
            });
            return content;
        };

        const renderManejoMedico = (d) => {
            if (!d.manejo_medico_y_seguimiento) return '';
            let content = `<h5 class="mt-4 mb-3 text-primary"><i class="bi bi-clipboard2-pulse-fill me-2"></i>Manejo Médico y Seguimiento</h6>`;
            if (d.manejo_medico_y_seguimiento.tratamiento_farmacologico_icc && d.manejo_medico_y_seguimiento.tratamiento_farmacologico_icc.length > 0) {
                content += `<h6>Tratamiento Farmacológico (si hay ICC)</h6><ul>`;
                d.manejo_medico_y_seguimiento.tratamiento_farmacologico_icc.forEach(m => { content += `<li class="small">${renderCodigo(m.codigo_item)}<strong>${m.nombre}:</strong> ${m.indicacion}</li>`; });
                content += `</ul>`;
            }
            if (d.manejo_medico_y_seguimiento.seguimiento_sin_cierre && d.manejo_medico_y_seguimiento.seguimiento_sin_cierre.length > 0) {
                content += `<h6 class="mt-3">Seguimiento (si no hay cierre)</h6><ul>`;
                d.manejo_medico_y_seguimiento.seguimiento_sin_cierre.forEach(s => { content += `<li class="small"><strong>${s.condicion}:</strong> ${s.descripcion}</li>`; });
                content += `</ul>`;
            }
            return content;
        };

        const renderManejoIntervencionista = (d) => {
            if (!d.manejo_intervencionista_cierre) return '';
            let content = `<h5 class="mt-4 mb-3 text-warning"><i class="bi bi-scissors me-2"></i>Manejo Intervencionista (Cierre)</h5>`;
            if (d.manejo_intervencionista_cierre.indicaciones_cierre && d.manejo_intervencionista_cierre.indicaciones_cierre.length > 0) {
                content += `<h6>Indicaciones de Cierre</h6><ul>`;
                d.manejo_intervencionista_cierre.indicaciones_cierre.forEach(i => { content += `<li class="small"><strong>${i.condicion}:</strong> ${i.criterios}</li>`; });
                content += `</ul>`;
            }
            if (d.manejo_intervencionista_cierre.tipos_de_cierre && d.manejo_intervencionista_cierre.tipos_de_cierre.length > 0) {
                content += `<h6 class="mt-3">Tipos de Cierre</h6><ul>`;
                d.manejo_intervencionista_cierre.tipos_de_cierre.forEach(t => { content += `<li class="small"><strong>${t.nombre}:</strong> ${t.descripcion}</li>`; });
                content += `</ul>`;
            }
            if (d.manejo_intervencionista_cierre.contraindicaciones && d.manejo_intervencionista_cierre.contraindicaciones.length > 0) {
                content += `<h6 class="mt-3 text-danger">Contraindicaciones</h6><ul>`;
                d.manejo_intervencionista_cierre.contraindicaciones.forEach(c => { content += `<li class="small"><strong>${c.procedimiento}:</strong> ${c.criterios}</li>`; });
                content += `</ul>`;
            }
            return content;
        };

        // --- CONSTRUCCIÓN DEL HTML FINAL ---
        html += renderPoblacion(data);
        html += renderDiagnostico(data);
        html += renderTratamientoAmbulatorio(data);
        html += renderTratamientoHospitalario(data);
        html += renderManejoMedico(data);
        html += renderManejoIntervencionista(data);
        
        html += `</div></div>`;
        contenedorSugerencias.innerHTML = html;
    }

    // --- SECCIÓN 3: EVENT LISTENER DEL INPUT (sin cambios) ---
    inputDiagnostico.addEventListener('input', function() {
        const valorInput = inputDiagnostico.value;
        const diagnosticoSeleccionado = allDiagnosticos.find(d => d.label === valorInput);
        
        if (diagnosticoSeleccionado) {
            consultarAsistenteIA(diagnosticoSeleccionado.value);
        }
    });
});
</script>
{% endblock %}
