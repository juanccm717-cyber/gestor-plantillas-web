{% extends "base.html" %}

{% block title %}Asistente Clínico{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Estilos para una presentación limpia y profesional */
    .guia-card { border-left: 4px solid #0d6efd; }
    .seccion-titulo { font-size: 1.1rem; font-weight: 500; color: #0d6efd; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
    .subseccion-titulo { font-size: 1rem; font-weight: 500; color: #343a40; margin-top: 1rem; }
    .item-recomendacion { padding-left: 1.5rem; position: relative; margin-bottom: 0.75rem; }
    .item-recomendacion::before { content: '•'; position: absolute; left: 0.5rem; color: #0d6efd; font-weight: bold; }
    .item-nombre { font-weight: bold; }
    .item-codigo { font-size: 0.8em; font-family: monospace; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h3 class="mb-0"><i class="bi bi-robot me-2"></i>Asistente de Consulta Clínica</h3>
            <small>Basado en Guías de Práctica Clínica Institucionales</small>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <label for="input-diagnostico" class="form-label fw-bold">1. Seleccione un Diagnóstico (CIE-10)</label>
                <input class="form-control form-control-lg" type="text" id="input-diagnostico" placeholder="Escriba el código o nombre del diagnóstico...">
            </div>
            <div>
                <h5 class="mb-3 fw-bold">2. Recomendaciones del Asistente</h5>
                <div id="asistente-ia-sugerencias">
                    <div class="alert alert-secondary text-center">
                        <i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico para ver las recomendaciones.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputDiagnostico = document.getElementById('input-diagnostico');
    const contenedorSugerencias = document.getElementById('asistente-ia-sugerencias');
    
    // --- 1. CARGA DE DIAGNÓSTICOS ---
    fetch('/api/get_all_diagnosticos')
        .then(response => response.json())
        .then(data => {
            const dataList = document.createElement('datalist');
            dataList.id = 'diagnosticos-list';
            data.forEach(d => {
                const option = document.createElement('option');
                option.value = d.codigo + ' - ' + d.descripcion;
                dataList.appendChild(option);
            });
            document.body.appendChild(dataList);
            inputDiagnostico.setAttribute('list', 'diagnosticos-list');
        })
        .catch(error => {
            console.error("Error al cargar la lista de diagnósticos:", error);
            contenedorSugerencias.innerHTML = '<div class="alert alert-danger">Error: No se pudo cargar la lista de diagnósticos. Verifique la consola.</div>';
        });

    // --- 2. FUNCIÓN DE CONSULTA ---
    function consultarAsistenteIA(textoInput) {
        const codigoCIE10 = textoInput.split(' - ')[0].trim();
        if (!codigoCIE10) return;

        contenedorSugerencias.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Consultando...</p></div>';
        fetch('/api/asistente_sugerencias?cie10=' + codigoCIE10)
            .then(response => {
                if (!response.ok) throw new Error('Guía no encontrada.');
                return response.json();
            })
            .then(data => renderizarGuia(data))
            .catch(error => {
                contenedorSugerencias.innerHTML = '<div class="alert alert-warning">' + error.message + '</div>';
            });
    }

    // --- 3. RENDERIZADOR (VERSIÓN A PRUEBA DE ERRORES DE SINTAXIS) ---
    function renderizarGuia(data) {
        let html = '<div class="card guia-card"><div class="card-header bg-light">';
        html += '<h5 class="mb-1">' + (data.nombre_guia || 'Guía sin nombre') + '</h5>';
        html += '<small class="text-muted">Versión: ' + (data.version_guia || 'N/A') + ' | Actualizado: ' + (data.fecha_actualizacion || 'N/A') + '</small>';
        html += '</div><div class="card-body">';

        function renderItem(item) {
            let itemHtml = '<div class="item-recomendacion">';
            itemHtml += '<span class="item-nombre">' + item.nombre + '</span>';
            if (item.codigo_item || item.codigo_procedimiento) {
                itemHtml += ' <span class="badge bg-secondary item-codigo">' + (item.codigo_item || item.codigo_procedimiento) + '</span>';
            }
            if (item.recomendacion) {
                itemHtml += '<div class="text-muted small">' + item.recomendacion.replace(/\n/g, '  
') + '</div>';
            }
            if (item.ejemplos) {
                itemHtml += '<ul>';
                item.ejemplos.forEach(function(ej) {
                    let codigoHtml = ej.codigo_item ? '<code>' + ej.codigo_item + '</code>' : '';
                    itemHtml += '<li><small><strong>' + ej.nombre + '</strong> (' + codigoHtml + '): ' + ej.dosis + '</small></li>';
                });
                itemHtml += '</ul>';
            }
            itemHtml += '</div>';
            return itemHtml;
        }

        function renderSecciones(secciones) {
            let seccionesHtml = '';
            if (!secciones) return '';
            secciones.forEach(function(seccion) {
                seccionesHtml += '<h6 class="seccion-titulo">' + seccion.titulo + '</h6>';
                if (seccion.contenido) {
                    seccionesHtml += '<p class="text-muted">' + seccion.contenido.replace(/\n/g, '  
') + '</p>';
                }
                if (seccion.items) {
                    secciones.items.forEach(function(item) {
                        seccionesHtml += renderItem(item);
                    });
                }
                if (seccion.subsecciones) {
                    seccion.subsecciones.forEach(function(sub) {
                        seccionesHtml += '<div class="ms-3">';
                        seccionesHtml += '<p class="subseccion-titulo">' + sub.titulo + '</p>';
                        if (sub.items) {
                            sub.items.forEach(function(item) {
                                seccionesHtml += renderItem(item);
                            });
                        }
                        seccionesHtml += '</div>';
                    });
                }
            });
            return seccionesHtml;
        }

        html += renderSecciones(data.secciones);
        html += '</div></div>';
        contenedorSugerencias.innerHTML = html;
    }

    // --- 4. EVENT LISTENER ---
    inputDiagnostico.addEventListener('input', function() {
        consultarAsistenteIA(this.value);
    });
});
</script>
{% endblock %}
