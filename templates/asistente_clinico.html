{% extends "base.html" %}

{% block title %}Asistente Clínico{% endblock %}

{% block head %}
{{ super() }}
<style>
    .guia-card { border-left: 4px solid #0d6efd; }
    .seccion-titulo { font-size: 1.1rem; font-weight: 500; color: #0d6efd; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
    .subseccion-titulo { font-size: 1rem; font-weight: 500; color: #343a40; margin-top: 1rem; }
    .item-recomendacion { padding-left: 1.5rem; position: relative; margin-bottom: 0.75rem; }
    .item-recomendacion::before { content: '•'; position: absolute; left: 0.5rem; color: #0d6efd; font-weight: bold; }
    .item-nombre { font-weight: bold; }
    .item-codigo { font-size: 0.8em; font-family: monospace; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h3 class="mb-0"><i class="bi bi-robot me-2"></i>Asistente de Consulta Clínica</h3>
            <small>Basado en Guías de Práctica Clínica Institucionales</small>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <label for="input-diagnostico" class="form-label fw-bold">1. Seleccione un Diagnóstico (CIE-10)</label>
                <input class="form-control form-control-lg" type="text" id="input-diagnostico" placeholder="Escriba el código o nombre del diagnóstico...">
            </div>
            <div>
                <h5 class="mb-3 fw-bold">2. Recomendaciones del Asistente</h5>
                <div id="asistente-ia-sugerencias">
                    <div class="alert alert-secondary text-center">
                        <i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico para ver las recomendaciones.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Usamos una función anónima para encapsular el código y evitar conflictos.
(function() {
    document.addEventListener('DOMContentLoaded', function() {

        var inputDiagnostico = document.getElementById('input-diagnostico');
        var contenedorSugerencias = document.getElementById('asistente-ia-sugerencias');

        // 1. Cargar la lista de diagnósticos.
        fetch('/api/get_all_diagnosticos')
            .then(function(response) {
                if (!response.ok) { throw new Error('Error de red al cargar diagnósticos'); }
                return response.json();
            })
            .then(function(data) {
                var dataList = document.createElement('datalist');
                dataList.id = 'diagnosticos-list';
                data.forEach(function(d) {
                    var option = document.createElement('option');
                    option.value = d.codigo + ' - ' + d.descripcion;
                    dataList.appendChild(option);
                });
                document.body.appendChild(dataList);
                inputDiagnostico.setAttribute('list', 'diagnosticos-list');
            })
            .catch(function(error) {
                console.error("Error CRÍTICO en fetch de diagnósticos:", error);
                contenedorSugerencias.innerHTML = '<div class="alert alert-danger">No se pudo cargar la lista de diagnósticos. Revise la conexión con el servidor.</div>';
            });

        // 2. Función que se activa al escribir en el campo de búsqueda.
        function buscarGuia() {
            var textoInput = inputDiagnostico.value;
            var codigoCIE10 = textoInput.split(' - ')[0].trim();

            if (!codigoCIE10) {
                contenedorSugerencias.innerHTML = '<div class="alert alert-secondary text-center"><i class="bi bi-info-circle me-2"></i>Seleccione un diagnóstico para ver las recomendaciones.</div>';
                return;
            }

            contenedorSugerencias.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Consultando...</p></div>';

            fetch('/api/asistente_sugerencias?cie10=' + codigoCIE10)
                .then(function(response) {
                    if (!response.ok) { throw new Error('No se encontró una guía para el CIE-10: ' + codigoCIE10); }
                    return response.json();
                })
                .then(function(data) {
                    renderizarGuia(data);
                })
                .catch(function(error) {
                    console.error("Error en fetch de sugerencias:", error);
                    contenedorSugerencias.innerHTML = '<div class="alert alert-warning text-center">' + error.message + '</div>';
                });
        }

        // 3. LA FUNCIÓN CLAVE: Renderizar la guía.
        function renderizarGuia(guia) {
            var html = '';
            html += '<div class="card guia-card">';
            html += '  <div class="card-header bg-light">';
            html += '    <h5 class="mb-1">' + (guia.nombre_guia || 'Guía sin Título') + '</h5>';
            html += '    <small class="text-muted">Versión: ' + (guia.version_guia || 'N/A') + ' | Actualizado: ' + (guia.fecha_actualizacion || 'N/A') + '</small>';
            html += '  </div>';
            html += '  <div class="card-body">';

            if (guia.secciones && guia.secciones.length > 0) {
                guia.secciones.forEach(function(seccion) {
                    html += '<h6 class="seccion-titulo">' + seccion.titulo + '</h6>';
                    if (seccion.contenido) {
                        html += '<p class="text-muted">' + seccion.contenido.replace(/\n/g, '  
') + '</p>';
                    }
                    if (seccion.items) {
                        seccion.items.forEach(function(item) {
                            html += renderizarItem(item);
                        });
                    }
                    if (seccion.subsecciones) {
                        seccion.subsecciones.forEach(function(sub) {
                            html += '<div class="ms-3">';
                            html += '  <p class="subseccion-titulo">' + sub.titulo + '</p>';
                            if (sub.items) {
                                sub.items.forEach(function(item) {
                                    html += renderizarItem(item);
                                });
                            }
                            html += '</div>';
                        });
                    }
                });
            } else {
                html += '<p>Esta guía no tiene secciones definidas.</p>';
            }

            html += '  </div>';
            html += '</div>';
            contenedorSugerencias.innerHTML = html;
        }

        // Función auxiliar para renderizar un solo item.
        function renderizarItem(item) {
            var itemHtml = '<div class="item-recomendacion">';
            itemHtml += '  <span class="item-nombre">' + item.nombre + '</span>';
            if (item.codigo_item || item.codigo_procedimiento) {
                itemHtml += ' <span class="badge bg-secondary item-codigo">' + (item.codigo_item || item.codigo_procedimiento) + '</span>';
            }
            if (item.recomendacion) {
                itemHtml += '<div class="text-muted small">' + item.recomendacion.replace(/\n/g, '  ') + '</div>';
            }
            if (item.ejemplos) {
                itemHtml += '<ul>';
                item.ejemplos.forEach(function(ej) {
                    var codigo = ej.codigo_item ? '<code>' + ej.codigo_item + '</code>' : '';
                    itemHtml += '<li><small><strong>' + ej.nombre + '</strong> (' + codigo + '): ' + ej.dosis + '</small></li>';
                });
                itemHtml += '</ul>';
            }
            itemHtml += '</div>';
            return itemHtml;
        }

        // 4. Conectar el evento 'input' del campo de búsqueda a nuestra función.
        inputDiagnostico.addEventListener('input', buscarGuia);
    });
})();
</script>
{% endblock %}
