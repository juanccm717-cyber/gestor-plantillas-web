{% extends "base.html" %}

{% block title %}Búsqueda de Diagnósticos (CIE-10){% endblock %}

{% block styles %}
<style>
    /* Estilo para el texto resaltado en los resultados de búsqueda */
    .table-hover tbody tr:hover {
        background-color: #495057; /* Un gris un poco más claro para el hover */
    }
    mark {
        background-color: #343a40; /* Fondo sutilmente más oscuro que el de la fila */
        color: #ffffff; /* Color de texto blanco para un alto contraste */
        padding: 0.1em 0; /* Un poco de padding vertical para que no se vea apretado */
        border-radius: 3px;
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header bg-dark-accent text-center py-3">
                    <h2 class="card-title mb-0"><i class="fas fa-search-plus me-2"></i>Búsqueda de Diagnósticos (CIE-10)</h2>
                </div>
                <div class="card-body p-4">
                    
                    <!-- Controles de Búsqueda -->
                    <div class="mb-3">
                        <input type="text" id="searchInput" class="form-control bg-dark text-white border-secondary" placeholder="Escribe un código o descripción (mín. 3 letras)..." autofocus>
                    </div>
                    
                    <!-- Controles de Estado y Botón (CORREGIDO) -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <!-- Cambiamos 'text-muted' por 'text-light' para mejorar el contraste -->
                            <div id="statusText" class="text-light small">Modo de búsqueda: <strong>Rápida (en servidor)</strong></div>
                            <div id="resultsCount" class="text-light small mt-1"></div>
                        </div>
                        <button id="loadAllButton" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-database me-2"></i>Cargar todos los diagnósticos
                        </button>
                    </div>

                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p id="loadingText" class="mt-2">Buscando...</p>
                    </div>

                    <!-- Tabla de Resultados -->
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-dark table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Código</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr><td colspan="2" class="text-center text-muted">Los resultados aparecerán aquí.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-center bg-dark-accent py-3">
                    <a href="{{ url_for('menu') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Volver al Menú</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ELEMENTOS DEL DOM ---
        const searchInput = document.getElementById('searchInput');
        const resultsBody = document.getElementById('resultsTableBody');
        const spinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        const loadAllButton = document.getElementById('loadAllButton');
        const statusText = document.getElementById('statusText');
        const resultsCount = document.getElementById('resultsCount');

        // --- ESTADO DE LA APLICACIÓN ---
        let searchMode = 'server';
        let allData = [];
        let debounceTimer;

        // --- FUNCIÓN PRINCIPAL DE BÚSQUEDA ---
        function performSearch() {
            clearTimeout(debounceTimer);
            const query = searchInput.value;

            if (searchMode === 'server' && query.length < 3) {
                resultsBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Escribe al menos 3 caracteres.</td></tr>';
                resultsCount.textContent = '';
                return;
            }

            debounceTimer = setTimeout(() => {
                if (searchMode === 'server') {
                    performServerSearch(query);
                } else {
                    performLocalFilter(query);
                }
            }, 300);
        }

        function performServerSearch(query) {
            loadingText.textContent = 'Buscando...';
            spinner.style.display = 'block';
            resultsBody.innerHTML = '';
            resultsCount.textContent = '';
            fetch(`/api/search_diagnosticos?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => handleNewData(data, query))
                .catch(handleError);
        }

        function performLocalFilter(query) {
            const upperQuery = query.toUpperCase();
            const filteredData = allData.filter(item => 
                item.codigo.toUpperCase().includes(upperQuery) || 
                item.descripcion.toUpperCase().includes(upperQuery)
            );
            handleNewData(filteredData, query);
        }

        // --- MANEJO DE DATOS Y RENDERIZADO (CON RESALTADO) ---
        function handleNewData(data, query) {
            spinner.style.display = 'none';
            if (!data || data.error) {
                resultsBody.innerHTML = `<tr><td colspan="2" class="text-center text-danger">Error al realizar la búsqueda.</td></tr>`;
                resultsCount.textContent = 'Error';
                return;
            }
            if (data.length === 0) {
                resultsBody.innerHTML = `<tr><td colspan="2" class="text-center text-muted">No se encontraron resultados para "${escapeHTML(searchInput.value)}".</td></tr>`;
                resultsCount.textContent = '0 resultados.';
            } else {
                const highlightRegex = query ? new RegExp(`(${escapeRegExp(query)})`, 'gi') : null;
                
                resultsBody.innerHTML = data.map(item => {
                    const highlightedCode = highlightRegex ? item.codigo.replace(highlightRegex, '<mark>$1</mark>') : item.codigo;
                    const highlightedDesc = highlightRegex ? item.descripcion.replace(highlightRegex, '<mark>$1</mark>') : item.descripcion;
                    
                    return `
                        <tr>
                            <td>${highlightedCode}</td>
                            <td>${highlightedDesc}</td>
                        </tr>
                    `;
                }).join('');

                // Actualizar contador
                if (searchMode === 'local') {
                    resultsCount.textContent = `Mostrando ${data.length} de ${allData.length} diagnósticos.`;
                } else {
                    resultsCount.textContent = `Se encontraron ${data.length} resultados.`;
                }
            }
        }

        function handleError(error) {
            spinner.style.display = 'none';
            resultsBody.innerHTML = `<tr><td colspan="2" class="text-center text-danger">Error de conexión.</td></tr>`;
            resultsCount.textContent = 'Error de conexión.';
        }

        // --- FUNCIONES AUXILIARES ---
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('keyup', performSearch);
        loadAllButton.addEventListener('click', function() {
            if (!confirm('Esto cargará la base de datos completa y puede tardar unos segundos. ¿Deseas continuar?')) return;
            loadingText.textContent = 'Cargando todos los diagnósticos...';
            spinner.style.display = 'block';
            this.disabled = true;
            fetch('/api/get_all_diagnosticos')
                .then(response => response.json())
                .then(data => {
                    if (data && !data.error) {
                        allData = data;
                        searchMode = 'local';
                        statusText.innerHTML = 'Modo de búsqueda: <strong>Local (en memoria)</strong>';
                        loadAllButton.style.display = 'none';
                        performLocalFilter(searchInput.value);
                    } else {
                        handleError();
                    }
                })
                .catch(handleError);
        });
    });
</script>
{% endblock %}
