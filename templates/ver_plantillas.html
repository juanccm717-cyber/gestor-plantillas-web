{% extends "base.html" %}

{% block title %}Ver Plantillas Existentes{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-white border-secondary shadow-lg">
        <div class="card-header bg-dark-accent d-flex justify-content-between align-items-center py-3">
            <h2 class="card-title mb-0"><i class="bi bi-card-list me-2"></i>Plantillas Existentes</h2>
            <a href="{{ url_for('menu') }}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left me-1"></i>Volver al Menú</a>
        </div>

        <div class="card-body p-4">
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por tipo de atención o código prestacional...">
                </div>
                <div class="col-md-4 text-md-end">
                    <small id="resultsCount" class="text-muted"></small>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="width: 10%;">ID</th>
                            <th>Tipo de Atención</th>
                            <th style="width: 20%;">Código Prestacional</th>
                            <th style="width: 25%;" class="text-center">Acciones</th> <!-- Ancho ajustado para más botones -->
                        </tr>
                    </thead>
                    <tbody id="registrosBody">
                        <!-- Las filas se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--               ¡MODIFICACIÓN REALIZADA AQUÍ! (1/2)             -->
<!-- ============================================================= -->
<!-- --- MODAL PARA VISUALIZAR EL PDF DE EJEMPLO --- -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfModalLabel">Ejemplo de Plantilla</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" style="height: 80vh;">
        <!-- El iframe se insertará aquí con JavaScript -->
        <div id="pdfViewerContainer" class="w-100 h-100"></div>
      </div>
    </div>
  </div>
</div>
<!-- --- FIN DEL MODAL --- -->
<!-- ============================================================= -->

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registrosBody = document.getElementById('registrosBody');
        const spinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const resultsCount = document.getElementById('resultsCount');
        let allRegistros = [];

        // =============================================================
        //               ¡MODIFICACIÓN REALIZADA AQUÍ! (2/2)             -->
        // =============================================================
        // --- REFERENCIA AL MODAL Y SU CONTENEDOR ---
        const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const pdfModalLabel = document.getElementById('pdfModalLabel');
        // --- FIN DE LA REFERENCIA ---

        function cargarRegistros() {
            spinner.style.display = 'block';
            fetch('{{ url_for("get_registros") }}')
                .then(response => response.json())
                .then(data => {
                    allRegistros = data;
                    renderTabla(allRegistros);
                    spinner.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error al cargar los registros:', error);
                    registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los registros.</td></tr>';
                    spinner.style.display = 'none';
                });
        }

        function renderTabla(registros) {
            registrosBody.innerHTML = '';

            if (registros.length === 0) {
                registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No se encontraron plantillas.</td></tr>';
            }

            registros.forEach(registro => {
                const fila = document.createElement('tr');
                const accionesCell = document.createElement('td');
                accionesCell.className = 'text-center';

                // --- BOTÓN DE VER EJEMPLO (Visible para todos) ---
                const verEjemploBtn = document.createElement('button');
                verEjemploBtn.className = 'btn btn-sm btn-outline-primary me-1';
                verEjemploBtn.title = 'Ver Ejemplo Llenado';
                verEjemploBtn.innerHTML = '<i class="bi bi-file-earmark-text-fill"></i>';
                verEjemploBtn.onclick = () => mostrarEjemplo(registro.id, registro.tipo_atencion);
                accionesCell.appendChild(verEjemploBtn);
                // --- FIN DEL BOTÓN ---

                const verBtn = document.createElement('a');
                verBtn.href = `/plantilla/${registro.id}`;
                verBtn.className = 'btn btn-sm btn-outline-info me-1';
                verBtn.title = 'Ver Detalles de Plantilla';
                verBtn.innerHTML = '<i class="bi bi-eye-fill"></i>';
                accionesCell.appendChild(verBtn);

                if ('{{ session.role }}' === 'administrador') {
                    const subirEjemploBtn = document.createElement('a');
                    subirEjemploBtn.href = `/gestionar_ejemplo/${registro.id}`;
                    subirEjemploBtn.className = 'btn btn-sm btn-outline-success me-1';
                    subirEjemploBtn.title = 'Subir/Actualizar Ejemplo PDF';
                    subirEjemploBtn.innerHTML = '<i class="bi bi-file-earmark-arrow-up-fill"></i>';
                    accionesCell.appendChild(subirEjemploBtn);

                    const editarBtn = document.createElement('a');
                    editarBtn.href = `/plantillas?modo=editar&id=${registro.id}`;
                    editarBtn.className = 'btn btn-sm btn-outline-warning me-1';
                    editarBtn.title = 'Editar Plantilla';
                    editarBtn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                    accionesCell.appendChild(editarBtn);

                    const eliminarBtn = document.createElement('button');
                    eliminarBtn.className = 'btn btn-sm btn-outline-danger';
                    eliminarBtn.title = 'Eliminar Plantilla';
                    eliminarBtn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                    eliminarBtn.onclick = () => eliminarRegistro(registro.id, registro.tipo_atencion);
                    accionesCell.appendChild(eliminarBtn);
                }

                fila.innerHTML = `
                    <td>${registro.id}</td>
                    <td>${registro.tipo_atencion}</td>
                    <td>${registro.codigo_prestacional}</td>
                `;
                fila.appendChild(accionesCell);
                registrosBody.appendChild(fila);
            });
            actualizarContador(registros.length);
        }

        // --- NUEVA FUNCIÓN PARA MOSTRAR EL PDF ---
        function mostrarEjemplo(plantillaId, nombrePlantilla) {
            const pdfUrl = `/static/ejemplos_plantillas/ejemplo_plantilla_${plantillaId}.pdf`;
            
            // Creamos el iframe para mostrar el PDF
            const iframe = document.createElement('iframe');
            iframe.src = pdfUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';

            // Limpiamos el contenedor y añadimos el nuevo iframe
            pdfViewerContainer.innerHTML = '';
            pdfViewerContainer.appendChild(iframe);

            // Actualizamos el título del modal y lo mostramos
            pdfModalLabel.textContent = `Ejemplo: ${nombrePlantilla}`;
            pdfModal.show();
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---

        function eliminarRegistro(id, nombre) {
            if (confirm(`¿Estás seguro de que quieres eliminar la plantilla "${nombre}" (ID: ${id})?`)) {
                fetch(`/delete_plantilla/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        allRegistros = allRegistros.filter(r => r.id !== id);
                        filtrarTabla();
                    })
                    .catch(error => console.error('Error al eliminar:', error));
            }
        }
        
        function filtrarTabla() {
            const textoBusqueda = searchInput.value.toLowerCase();
            const registrosFiltrados = allRegistros.filter(registro => {
                const textoRegistro = (registro.tipo_atencion + ' ' + registro.codigo_prestacional).toLowerCase();
                return textoRegistro.includes(textoBusqueda);
            });
            renderTabla(registrosFiltrados);
        }

        function actualizarContador(visibles) {
             if (allRegistros.length === visibles && searchInput.value === '') {
                resultsCount.textContent = `Mostrando ${allRegistros.length} plantillas.`;
            } else {
                resultsCount.textContent = `Mostrando ${visibles} de ${allRegistros.length} plantillas.`;
            }
        }

        cargarRegistros();
        searchInput.addEventListener('keyup', filtrarTabla);
        window.eliminarRegistro = eliminarRegistro;
        window.mostrarEjemplo = mostrarEjemplo; // Hacemos la función accesible globalmente
    });
</script>
{% endblock %}
