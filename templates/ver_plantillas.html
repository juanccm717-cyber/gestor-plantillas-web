{% extends "base.html" %}

{% block title %}Ver Plantillas Existentes{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-white border-secondary shadow-lg">
        <div class="card-header bg-dark-accent d-flex justify-content-between align-items-center py-3">
            <h2 class="card-title mb-0"><i class="bi bi-card-list me-2"></i>Plantillas Existentes</h2>
            <a href="{{ url_for('menu') }}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left me-1"></i>Volver al Menú</a>
        </div>

        <div class="card-body p-4">
            <!-- ================================== -->
            <!-- CAMPO DE BÚSQUEDA Y CONTADOR (NUEVO) -->
            <!-- ================================== -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por tipo de atención, código o descripción...">
                </div>
                <div class="col-md-4 text-md-end">
                    <small id="resultsCount" class="text-muted"></small>
                </div>
            </div>
            
            <!-- Tabla de Registros -->
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="width: 10%;">ID</th>
                            <th>Tipo de Atención</th>
                            <th style="width: 20%;">Código Prestacional</th>
                            <th style="width: 15%;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="registrosBody">
                        <!-- Las filas se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registrosBody = document.getElementById('registrosBody');
        const spinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput'); // NUEVO
        const resultsCount = document.getElementById('resultsCount'); // NUEVO
        let allRegistros = []; // Almacenaremos todos los registros aquí

        function cargarRegistros() {
            spinner.style.display = 'block';
            fetch('{{ url_for("get_registros") }}')
                .then(response => response.json())
                .then(data => {
                    allRegistros = data; // Guardamos los datos originales
                    renderTabla(allRegistros); // Renderizamos la tabla inicial
                    spinner.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error al cargar los registros:', error);
                    registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los registros.</td></tr>';
                    spinner.style.display = 'none';
                });
        }

        function renderTabla(registros) {
            registrosBody.innerHTML = '';
            if (registros.length === 0) {
                registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No se encontraron plantillas.</td></tr>';
                resultsCount.textContent = '0 resultados.';
                return;
            }

            registros.forEach(registro => {
                const fila = document.createElement('tr');
                
                // Condicional para mostrar botones solo si el usuario es administrador
                let botonesAdmin = '';
                if ('{{ session.role }}' === 'administrador') {
                    botonesAdmin = `
                        <a href="/plantillas?modo=editar&id=${registro.id}" class="btn btn-sm btn-outline-warning me-1" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                        <button onclick="eliminarRegistro(${registro.id})" class="btn btn-sm btn-outline-danger" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
                    `;
                }

                fila.innerHTML = `
                    <td>${registro.id}</td>
                    <td>${registro.tipo_atencion}</td>
                    <td>${registro.codigo_prestacional}</td>
                    <td class="text-center">
                        <a href="/plantilla/${registro.id}" class="btn btn-sm btn-outline-info me-1" title="Ver"><i class="bi bi-eye-fill"></i></a>
                        ${botonesAdmin}
                    </td>
                `;
                registrosBody.appendChild(fila);
            });

            // Actualizar contador
            if (allRegistros.length === registros.length) {
                resultsCount.textContent = `Mostrando ${registros.length} plantillas.`;
            } else {
                resultsCount.textContent = `Mostrando ${registros.length} de ${allRegistros.length} plantillas.`;
            }
        }

        function eliminarRegistro(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta plantilla? Esta acción no se puede deshacer.')) {
                fetch(`/delete_plantilla/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        cargarRegistros(); // Recargar la lista después de eliminar
                    })
                    .catch(error => console.error('Error al eliminar:', error));
            }
        }

        // ==================================
        // FUNCIÓN DE FILTRADO (NUEVA)
        // ==================================
        function filtrarTabla() {
            const textoBusqueda = searchInput.value.toLowerCase();
            const filas = registrosBody.getElementsByTagName('tr');
            let conteoVisibles = 0;

            for (let i = 0; i < filas.length; i++) {
                const fila = filas[i];
                const celdaTipoAtencion = fila.cells[1];
                const celdaCodigo = fila.cells[2];
                
                if (celdaTipoAtencion && celdaCodigo) {
                    const textoFila = (celdaTipoAtencion.textContent + ' ' + celdaCodigo.textContent).toLowerCase();
                    if (textoFila.includes(textoBusqueda)) {
                        fila.style.display = '';
                        conteoVisibles++;
                    } else {
                        fila.style.display = 'none';
                    }
                }
            }
            // Actualizar contador en tiempo real
            resultsCount.textContent = `Mostrando ${conteoVisibles} de ${allRegistros.length} plantillas.`;
        }

        // --- INICIALIZACIÓN ---
        cargarRegistros();
        
        // Asignar el evento al campo de búsqueda
        searchInput.addEventListener('keyup', filtrarTabla);

        // Hacemos la función eliminarRegistro accesible globalmente
        window.eliminarRegistro = eliminarRegistro;
    });
</script>
{% endblock %}
