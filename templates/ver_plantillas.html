{% extends "base.html" %}

{% block title %}Ver Plantillas Existentes{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-white border-secondary shadow-lg">
        <div class="card-header bg-dark-accent d-flex justify-content-between align-items-center py-3">
            <h2 class="card-title mb-0"><i class="bi bi-card-list me-2"></i>Plantillas Existentes</h2>
            <a href="{{ url_for('menu') }}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left me-1"></i>Volver al Menú</a>
        </div>

        <div class="card-body p-4">
            <!-- ================================== -->
            <!-- CAMPO DE BÚSQUEDA Y CONTADOR (NUEVO) -->
            <!-- ================================== -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por tipo de atención o código prestacional...">
                </div>
                <div class="col-md-4 text-md-end">
                    <small id="resultsCount" class="text-muted"></small>
                </div>
            </div>
            
            <!-- Tabla de Registros -->
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="width: 10%;">ID</th>
                            <th>Tipo de Atención</th>
                            <th style="width: 20%;">Código Prestacional</th>
                            <th style="width: 15%;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="registrosBody">
                        <!-- Las filas se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registrosBody = document.getElementById('registrosBody');
        const spinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const resultsCount = document.getElementById('resultsCount');
        let allRegistros = []; // Almacenaremos todos los registros originales aquí

        // Carga inicial de datos desde la API
        function cargarRegistros() {
            spinner.style.display = 'block';
            fetch('{{ url_for("get_registros") }}')
                .then(response => response.json())
                .then(data => {
                    allRegistros = data;
                    renderTabla(allRegistros); // Renderiza la tabla completa la primera vez
                    spinner.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error al cargar los registros:', error);
                    registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los registros.</td></tr>';
                    spinner.style.display = 'none';
                });
        }

        // Renderiza la tabla con un array de registros dado
        function renderTabla(registros) {
            registrosBody.innerHTML = ''; // Limpia la tabla antes de renderizar

            if (registros.length === 0) {
                registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No se encontraron plantillas que coincidan con la búsqueda.</td></tr>';
            }

            registros.forEach(registro => {
                const fila = document.createElement('tr');
                
                const accionesCell = document.createElement('td');
                accionesCell.className = 'text-center';

                // Botón de Ver (siempre visible)
                const verBtn = document.createElement('a');
                verBtn.href = `/plantilla/${registro.id}`;
                verBtn.className = 'btn btn-sm btn-outline-info me-1';
                verBtn.title = 'Ver';
                verBtn.innerHTML = '<i class="bi bi-eye-fill"></i>';
                accionesCell.appendChild(verBtn);

                // Botones de Admin (solo si el rol es 'administrador')
                if ('{{ session.role }}' === 'administrador') {
                    const editarBtn = document.createElement('a');
                    editarBtn.href = `/plantillas?modo=editar&id=${registro.id}`;
                    editarBtn.className = 'btn btn-sm btn-outline-warning me-1';
                    editarBtn.title = 'Editar';
                    editarBtn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                    accionesCell.appendChild(editarBtn);

                    const eliminarBtn = document.createElement('button');
                    eliminarBtn.className = 'btn btn-sm btn-outline-danger';
                    eliminarBtn.title = 'Eliminar';
                    eliminarBtn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                    eliminarBtn.onclick = function() { eliminarRegistro(registro.id, registro.tipo_atencion); };
                    accionesCell.appendChild(eliminarBtn);
                }

                fila.innerHTML = `
                    <td>${registro.id}</td>
                    <td>${registro.tipo_atencion}</td>
                    <td>${registro.codigo_prestacional}</td>
                `;
                fila.appendChild(accionesCell);
                registrosBody.appendChild(fila);
            });
            actualizarContador(registros.length);
        }

        // Función para eliminar un registro
        function eliminarRegistro(id, nombre) {
            if (confirm(`¿Estás seguro de que quieres eliminar la plantilla "${nombre}" (ID: ${id})?`)) {
                fetch(`/delete_plantilla/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        allRegistros = allRegistros.filter(r => r.id !== id);
                        filtrarTabla(); // Vuelve a renderizar la tabla con los datos actualizados
                    })
                    .catch(error => console.error('Error al eliminar:', error));
            }
        }
        
        // Función principal de filtrado
        function filtrarTabla() {
            const textoBusqueda = searchInput.value.toLowerCase();
            const registrosFiltrados = allRegistros.filter(registro => {
                const textoRegistro = (registro.tipo_atencion + ' ' + registro.codigo_prestacional).toLowerCase();
                return textoRegistro.includes(textoBusqueda);
            });
            renderTabla(registrosFiltrados);
        }

        // Actualiza el texto del contador de resultados
        function actualizarContador(visibles) {
             if (allRegistros.length === visibles && searchInput.value === '') {
                resultsCount.textContent = `Mostrando ${allRegistros.length} plantillas.`;
            } else {
                resultsCount.textContent = `Mostrando ${visibles} de ${allRegistros.length} plantillas.`;
            }
        }

        // --- INICIALIZACIÓN ---
        cargarRegistros();
        searchInput.addEventListener('keyup', filtrarTabla);
        window.eliminarRegistro = eliminarRegistro; // Hace la función accesible globalmente
    });
</script>
{% endblock %}
