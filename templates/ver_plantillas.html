{% extends "base.html" %}

{% block title %}Ver Plantillas Existentes{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-white border-secondary shadow-lg">
        <div class="card-header bg-dark-accent d-flex justify-content-between align-items-center py-3">
            <h2 class="card-title mb-0"><i class="bi bi-card-list me-2"></i>Plantillas Existentes</h2>
            <a href="{{ url_for('menu') }}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left me-1"></i>Volver al Menú</a>
        </div>

        <div class="card-body p-4">
            <!-- Campo de Búsqueda y Contador -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por tipo de atención, código o descripción...">
                </div>
                <div class="col-md-4 text-md-end">
                    <small id="resultsCount" class="text-muted"></small>
                </div>
            </div>
            
            <!-- Tabla de Registros -->
            <div class="table-responsive">
                <table class="table table-dark table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="width: 10%;">ID</th>
                            <th>Tipo de Atención</th>
                            <th style="width: 20%;">Código Prestacional</th>
                            <th style="width: 15%;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="registrosBody">
                        <!-- Las filas se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registrosBody = document.getElementById('registrosBody');
        const spinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const resultsCount = document.getElementById('resultsCount');
        let allRegistros = [];

        function cargarRegistros() {
            spinner.style.display = 'block';
            fetch('{{ url_for("get_registros") }}')
                .then(response => response.json())
                .then(data => {
                    allRegistros = data;
                    renderTabla(allRegistros);
                    spinner.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error al cargar los registros:', error);
                    registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los registros.</td></tr>';
                    spinner.style.display = 'none';
                });
        }

        function renderTabla(registros) {
            registrosBody.innerHTML = '';
            if (registros.length === 0) {
                registrosBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No se encontraron plantillas que coincidan con la búsqueda.</td></tr>';
                resultsCount.textContent = '0 resultados.';
                return;
            }

            // =================================================================
            // INICIO DEL BLOQUE CORREGIDO
            // =================================================================
            registros.forEach(registro => {
                const fila = document.createElement('tr');
                
                // Se construye la celda de acciones dinámicamente
                const accionesCell = document.createElement('td');
                accionesCell.className = 'text-center';

                // 1. Botón de Ver (siempre visible)
                const verBtn = document.createElement('a');
                verBtn.href = `/plantilla/${registro.id}`;
                verBtn.className = 'btn btn-sm btn-outline-info me-1';
                verBtn.title = 'Ver';
                verBtn.innerHTML = '<i class="bi bi-eye-fill"></i>';
                accionesCell.appendChild(verBtn);

                // 2. Botones de Admin (solo si el rol es 'administrador')
                if ('{{ session.role }}' === 'administrador') {
                    // Botón de Editar
                    const editarBtn = document.createElement('a');
                    editarBtn.href = `/plantillas?modo=editar&id=${registro.id}`;
                    editarBtn.className = 'btn btn-sm btn-outline-warning me-1';
                    editarBtn.title = 'Editar';
                    editarBtn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                    accionesCell.appendChild(editarBtn);

                    // Botón de Eliminar
                    const eliminarBtn = document.createElement('button');
                    eliminarBtn.className = 'btn btn-sm btn-outline-danger';
                    eliminarBtn.title = 'Eliminar';
                    eliminarBtn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                    eliminarBtn.onclick = function() { eliminarRegistro(registro.id, registro.tipo_atencion); }; // Pasamos el nombre para el confirm
                    accionesCell.appendChild(eliminarBtn);
                }

                // Se construye el resto de la fila
                fila.innerHTML = `
                    <td>${registro.id}</td>
                    <td>${registro.tipo_atencion}</td>
                    <td>${registro.codigo_prestacional}</td>
                `;
                fila.appendChild(accionesCell); // Se añade la celda de acciones al final

                registrosBody.appendChild(fila);
            });
            // =================================================================
            // FIN DEL BLOQUE CORREGIDO
            // =================================================================

            // Actualizar contador
            actualizarContador(registros.length);
        }

        function eliminarRegistro(id, nombre) {
            if (confirm(`¿Estás seguro de que quieres eliminar la plantilla "${nombre}" (ID: ${id})? Esta acción no se puede deshacer.`)) {
                fetch(`/delete_plantilla/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        // Recargar la lista desde la variable local para evitar otra llamada a la API
                        allRegistros = allRegistros.filter(r => r.id !== id);
                        filtrarTabla(); // Volver a renderizar la tabla con los datos filtrados
                    })
                    .catch(error => console.error('Error al eliminar:', error));
            }
        }
        
        function filtrarTabla() {
            const textoBusqueda = searchInput.value.toLowerCase();
            
            const registrosFiltrados = allRegistros.filter(registro => {
                const textoRegistro = (registro.tipo_atencion + ' ' + registro.codigo_prestacional).toLowerCase();
                return textoRegistro.includes(textoBusqueda);
            });

            renderTabla(registrosFiltrados);
        }

        function actualizarContador(visibles) {
             if (allRegistros.length === visibles) {
                resultsCount.textContent = `Mostrando ${allRegistros.length} plantillas.`;
            } else {
                resultsCount.textContent = `Mostrando ${visibles} de ${allRegistros.length} plantillas.`;
            }
        }

        // --- INICIALIZACIÓN ---
        cargarRegistros();
        searchInput.addEventListener('keyup', filtrarTabla);
        window.eliminarRegistro = eliminarRegistro;
    });
</script>
{% endblock %}
