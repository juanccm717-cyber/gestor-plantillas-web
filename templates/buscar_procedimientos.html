{% extends "base.html" %}

{% block title %}Búsqueda de Procedimientos{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="text-center mb-4">
                <i class="bi bi-heart-pulse" style="font-size: 3rem; color: #0dcaf0;"></i>
                <h1 class="mt-2">Buscador de Procedimientos</h1>
                <p class="lead text-muted">
                    Escribe parte del nombre de un procedimiento para encontrar su código (CPMS).
                </p>
            </div>

            <!-- Barra de Búsqueda -->
            <div class="input-group input-group-lg mb-4 shadow-sm">
                <span class="input-group-text" id="search-icon"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Ej: Anestesia, Colecistectomía, Endoscopia..." aria-label="Buscar procedimiento" aria-describedby="search-icon">
            </div>

            <!-- Contenedor para los Resultados y Mensajes -->
            <div id="resultsContainer">
                <!-- ... (Los mensajes de inicial, carga y no resultados son los mismos) ... -->
                <div id="initialMessage" class="text-center text-muted mt-5">
                    <p><i class="bi bi-keyboard fs-2"></i></p>
                    <p>Los resultados de la búsqueda aparecerán aquí.</p>
                </div>
                <div id="loadingSpinner" class="text-center mt-5 d-none">
                    <div class="spinner-border text-info" role="status"><span class="visually-hidden">Buscando...</span></div>
                    <p class="mt-2">Buscando...</p>
                </div>
                <div id="noResultsMessage" class="text-center text-muted mt-5 d-none">
                    <p><i class="bi bi-emoji-frown fs-2"></i></p>
                    <p>No se encontraron procedimientos que coincidan con tu búsqueda.</p>
                </div>

                <!-- Tabla de Resultados -->
                <div class="table-responsive d-none" id="resultsTableContainer">
                    <table class="table table-hover table-striped align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Código (CPMS)</th>
                                <th scope="col">Nombre del Procedimiento</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody">
                            <!-- Las filas se insertarán aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- ================================================== -->
                <!--    (¡NUEVO!) NOTA DE PIE DE PÁGINA CON LA RESOLUCIÓN    -->
                <!-- ================================================== -->
                <div class="text-center mt-4">
                    <small class="text-muted">
                        <strong>Fuente:</strong> TARIFARIO SIS 2025 - Resolución Jefatural N.° 000124-2025-SIS/J
                    </small>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (las variables iniciales son las mismas) ...
    const searchInput = document.getElementById('searchInput');
    const resultsTbody = document.getElementById('resultsTbody');
    const initialMessage = document.getElementById('initialMessage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const resultsTableContainer = document.getElementById('resultsTableContainer');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        // ... (la lógica del debounce y fetch es la misma) ...
        const query = searchInput.value.trim();
        clearTimeout(searchTimeout);
        if (query.length < 2) {
            resetView();
            return;
        }
        showLoading();
        searchTimeout = setTimeout(() => {
            fetch(`/api/search_procedimientos?q=${encodeURIComponent(query)}`)
                .then(response => response.ok ? response.json() : Promise.reject('Error de red'))
                .then(data => displayResults(data))
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                    showErrorState();
                });
        }, 300);
    });

    // ====================================================================
    //        (¡ACTUALIZADO!) FUNCIÓN CON LA LÓGICA DE COLOR CORRECTA
    // ====================================================================
    function displayResults(data) {
        resultsTbody.innerHTML = '';
        hideAllMessages();

        if (data && data.length > 0) {
            data.forEach(proc => {
                const row = document.createElement('tr');
                
                // LÓGICA DE COLOR CORREGIDA:
                // Solo pintamos de rojo si la tarifa es 'N/C' (No Cobertura).
                const tarifa = (proc.tarifa_sis || '').trim().toUpperCase();
                if (tarifa === 'N/C') {
                    row.classList.add('table-danger'); // Clase de Bootstrap para fondo rojo claro
                }

                // Creamos el HTML de la fila (sin la columna de tarifa)
                row.innerHTML = `
                    <td>${proc.cod_cpms || 'N/A'}</td>
                    <td>${proc.nombre_prest || 'Sin descripción'}</td>
                `;
                resultsTbody.appendChild(row);
            });
            resultsTableContainer.classList.remove('d-none');
        } else {
            noResultsMessage.classList.remove('d-none');
        }
    }

    // ... (el resto de las funciones auxiliares son las mismas) ...
    function resetView() {
        hideAllMessages();
        initialMessage.classList.remove('d-none');
    }
    function showLoading() {
        hideAllMessages();
        loadingSpinner.classList.remove('d-none');
    }
    function showErrorState() {
        hideAllMessages();
        noResultsMessage.querySelector('p:last-child').textContent = 'Ocurrió un error al realizar la búsqueda. Inténtalo de nuevo.';
        noResultsMessage.classList.remove('d-none');
    }
    function hideAllMessages() {
        initialMessage.classList.add('d-none');
        loadingSpinner.classList.add('d-none');
        noResultsMessage.classList.add('d-none');
        resultsTableContainer.classList.add('d-none');
    }
});
</script>
{% endblock %}
