{% extends "base.html" %}

{% block title %}Calculadora de IMC{% endblock %}

{% block head %}
<style>
    /* Estilos para la barra de progreso y su indicador */
    .imc-scale-container {
        position: relative;
        margin-top: 1.5rem;
        padding-bottom: 2.5rem; 
    }
    .imc-indicator {
        position: absolute;
        bottom: 20px; /* Alineado con la parte superior de la barra */
        width: 3px;
        height: 25px;
        background-color: #fff;
        transform: translateX(-50%);
        transition: left 0.5s ease-out;
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        border-radius: 1.5px;
        z-index: 10;
    }
    .imc-indicator-label {
        position: absolute;
        bottom: -10px;
        font-size: 0.9rem;
        font-weight: bold;
        color: #fff;
        transform: translateX(-50%);
        transition: left 0.5s ease-out;
        white-space: nowrap;
        text-shadow: 0 0 3px rgba(0,0,0,0.7);
    }
    /* NUEVO: Estilos para las etiquetas de los rangos */
    .range-labels {
        position: relative;
        height: 20px;
        margin-top: -20px; /* Alinea las etiquetas con la barra */
    }
    .range-label {
        position: absolute;
        bottom: -20px;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header bg-dark-accent text-center py-3">
                    <h2 class="card-title mb-0"><i class="fas fa-calculator me-2"></i>Calculadora de IMC</h2>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="peso" class="form-label">Peso (en kilogramos)</label>
                        <input type="number" class="form-control" id="peso" placeholder="Ej: 70.5">
                    </div>
                    <div class="mb-3">
                        <label for="talla" class="form-label">Talla (en centímetros)</label>
                        <input type="number" class="form-control" id="talla" placeholder="Ej: 175">
                    </div>                  
                    <div id="resultado-area" class="mt-4 text-center" style="display: none; opacity: 0; transition: opacity 0.5s;">
                        <hr>
                        <h4>Resultado</h4>
                        <p class="display-4 fw-bold" id="imc-valor"></p>
                        <p class="fs-4" id="imc-interpretacion"></p>

                        <!-- INICIO DE LA MEJORA VISUAL v4.0 -->
                        <div class="imc-scale-container">
                            <!-- Barra de progreso con anchos proporcionales -->
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 23.33%"></div>
                                <div class="progress-bar bg-success" role="progressbar" style="width: 43.33%"></div>
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 33.34%"></div>
                            </div>
                            <!-- Contenedor para el indicador y las etiquetas -->
                            <div class="range-labels">
                                <div id="indicator-container"></div>
                                <div class="range-label" style="left: 23.33%;">18.5</div>
                                <div class="range-label" style="left: 66.66%;">25</div>
                                <div class="range-label" style="left: 100%;">30</div>
                            </div>
                        </div>
                        <!-- FIN DE LA MEJORA VISUAL v4.0 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const inputPeso = document.getElementById('peso');
    const inputTalla = document.getElementById('talla');
    const resultadoArea = document.getElementById('resultado-area');
    const imcValor = document.getElementById('imc-valor');
    const imcInterpretacion = document.getElementById('imc-interpretacion');
    const indicatorContainer = document.getElementById('indicator-container');

    function calcularIMC() {
        const peso = parseFloat(inputPeso.value);
        const tallaCm = parseFloat(inputTalla.value);

        if (isNaN(peso) || isNaN(tallaCm) || peso <= 0 || tallaCm <= 0) {
            resultadoArea.style.opacity = '0';
            setTimeout(() => { resultadoArea.style.display = 'none'; }, 500);
            return;
        }

        const tallaM = tallaCm / 100;
        const imc = peso / (tallaM * tallaM);
        const imcRedondeado = imc.toFixed(2);

        let interpretacion = '';
        let colorClase = '';

        // Definimos los rangos de forma clara
        const RANGOS = {
            BAJO_PESO: 18.5,
            NORMAL: 25,
            SOBREPESO: 30,
        };
        
        // Lógica de interpretación
        if (imc < RANGOS.BAJO_PESO) {
            interpretacion = 'Bajo Peso';
            colorClase = 'text-info';
        } else if (imc < RANGOS.NORMAL) {
            interpretacion = 'Peso Normal';
            colorClase = 'text-success';
        } else if (imc < RANGOS.SOBREPESO) {
            interpretacion = 'Sobrepeso';
            colorClase = 'text-warning';
        } else {
            interpretacion = 'Obesidad';
            colorClase = 'text-danger';
        }

        imcValor.innerText = imcRedondeado;
        imcInterpretacion.innerText = interpretacion;
        imcInterpretacion.className = 'fs-4 ' + colorClase;
        
        // --- LÓGICA DE POSICIONAMIENTO CORREGIDA ---
        const minVisibleIMC = 15;
        const maxVisibleIMC = 30; // El final de la barra visible es 30
        
        let percentPosition = ((imc - minVisibleIMC) / (maxVisibleIMC - minVisibleIMC)) * 100;
        
        // Aplicamos límites para que el indicador no se salga
        percentPosition = Math.max(0, Math.min(100, percentPosition));

        indicatorContainer.innerHTML = `
            <div class="imc-indicator" style="left: ${percentPosition}%;"></div>
            <div class="imc-indicator-label" style="left: ${percentPosition}%;">Tú</div>
        `;
        
        resultadoArea.style.display = 'block';
        setTimeout(() => { resultadoArea.style.opacity = '1'; }, 10);
    }

    inputPeso.addEventListener('input', calcularIMC);
    inputTalla.addEventListener('input', calcularIMC);
</script>
{% endblock %}
