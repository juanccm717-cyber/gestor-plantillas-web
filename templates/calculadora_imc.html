{% extends "base.html" %}

{% block title %}Calculadora de IMC{% endblock %}

{% block head %}
<style>
    /* Estilos para la barra de progreso y su indicador */
    .imc-scale-container {
        position: relative;
        margin-top: 1.5rem;
        padding-bottom: 2.5rem; 
    }
    .imc-indicator {
        position: absolute;
        bottom: 20px;
        width: 2px;
        height: 30px;
        background-color: #fff;
        transform: translateX(-50%);
        transition: left 0.5s ease-out;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        border-radius: 1px;
    }
    .imc-indicator-label {
        position: absolute;
        bottom: -5px;
        font-size: 0.8rem;
        color: #fff;
        transform: translateX(-50%);
        transition: left 0.5s ease-out;
        white-space: nowrap;
    }

    /* MEJORA 1: Estilos para las etiquetas de rango */
    .range-label {
        position: absolute;
        top: -20px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.7);
        transform: translateX(-50%);
    }

    /* MEJORA 2: Animación de aparición suave */
    #resultado-area {
        transition: opacity 0.5s ease-in-out;
    }

    /* MEJORA 3: Estilo para campos con error */
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header bg-dark-accent text-center py-3">
                    <h2 class="card-title mb-0"><i class="fas fa-calculator me-2"></i>Calculadora de IMC</h2>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="peso" class="form-label">Peso (en kilogramos)</label>
                        <input type="number" class="form-control" id="peso" placeholder="Ej: 70.5">
                    </div>
                    <div class="mb-3">
                        <label for="talla" class="form-label">Talla (en centímetros)</label>
                        <input type="number" class="form-control" id="talla" placeholder="Ej: 175">
                    </div>                  
                    <div id="resultado-area" class="mt-4 text-center" style="display: none; opacity: 0;">
                        <hr>
                        <h4>Resultado</h4>
                        <p class="display-4" id="imc-valor"></p>
                        <p class="fs-4" id="imc-interpretacion"></p>

                        <div class="imc-scale-container">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 25%"></div>
                                <div class="progress-bar bg-success" role="progressbar" style="width: 25%"></div>
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%"></div>
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 25%"></div>
                            </div>
                            <!-- MEJORA 1: Etiquetas de rango -->
                            <span class="range-label" style="left: 25%;">18.5</span>
                            <span class="range-label" style="left: 50%;">25</span>
                            <span class="range-label" style="left: 75%;">30</span>

                            <div id="indicator-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const inputPeso = document.getElementById('peso');
    const inputTalla = document.getElementById('talla');
    const resultadoArea = document.getElementById('resultado-area');
    const imcValor = document.getElementById('imc-valor');
    const imcInterpretacion = document.getElementById('imc-interpretacion');

    function validarInput(input) {
        const valor = parseFloat(input.value);
        if (isNaN(valor) || valor <= 0) {
            if (input.value !== '') {
                input.classList.add('is-invalid');
            }
            return false;
        } else {
            input.classList.remove('is-invalid');
            return true;
        }
    }

    function calcularIMC() {
        const esPesoValido = validarInput(inputPeso);
        const esTallaValida = validarInput(inputTalla);

        if (!esPesoValido || !esTallaValida) {
            resultadoArea.style.opacity = '0';
            setTimeout(() => { resultadoArea.style.display = 'none'; }, 500);
            return;
        }

        const peso = parseFloat(inputPeso.value);
        const tallaCm = parseFloat(inputTalla.value);
        const tallaM = tallaCm / 100;
        const imc = peso / (tallaM * tallaM);
        const imcRedondeado = imc.toFixed(2);

        let interpretacion = '';
        let colorClase = '';

        if (imc < 18.5) {
            interpretacion = 'Bajo Peso';
            colorClase = 'text-info';
        } else if (imc >= 18.5 && imc < 25) {
            interpretacion = 'Peso Normal';
            colorClase = 'text-success';
        } else if (imc >= 25 && imc < 30) {
            interpretacion = 'Sobrepeso';
            colorClase = 'text-warning';
        } else {
            interpretacion = 'Obesidad';
            colorClase = 'text-danger';
        }

        imcValor.innerText = imcRedondeado;
        imcInterpretacion.innerText = interpretacion;
        imcInterpretacion.className = 'fs-4 ' + colorClase;
        
        const indicatorContainer = document.getElementById('indicator-container');
        const minIMC = 15;
        const maxIMC = 40;
        let percentPosition = ((imc - minIMC) / (maxIMC - minIMC)) * 100;
        percentPosition = Math.max(0, Math.min(100, percentPosition));

        indicatorContainer.innerHTML = `
            <div class="imc-indicator" style="left: ${percentPosition}%;"></div>
            <div class="imc-indicator-label" style="left: ${percentPosition}%;">Tú estás aquí</div>
        `;
        
        resultadoArea.style.display = 'block';
        setTimeout(() => { resultadoArea.style.opacity = '1'; }, 10);
    }

    inputPeso.addEventListener('input', calcularIMC);
    inputTalla.addEventListener('input', calcularIMC);
</script>
{% endblock %}
