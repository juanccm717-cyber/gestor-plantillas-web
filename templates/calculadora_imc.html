{% extends "base.html" %}

{% block title %}Calculadora Universal de IMC{% endblock %}

{% block styles %}
<style>
    #resultado-area {
        transition: opacity 0.5s ease-in-out;
        opacity: 0;
        display: none;
    }
    #resultado-area.visible {
        opacity: 1;
        display: block;
    }
    .accordion-button:not(.collapsed) {
        background-color: #343a40;
        color: #fff;
    }
    .imc-valor {
        font-size: 2rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header bg-dark-accent text-center py-3">
                    <h2 class="card-title mb-0"><i class="bi bi-calculator me-2"></i>Calculadora Universal de IMC</h2>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted">Introduce el peso y la talla para ver la interpretación del IMC en diferentes grupos.</p>
                    <div class="mb-3">
                        <label for="peso" class="form-label">Peso (en kilogramos)</label>
                        <input type="number" class="form-control" id="peso" placeholder="Ej: 70.5" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label for="talla" class="form-label">Talla (en centímetros)</label>
                        <input type="number" class="form-control" id="talla" placeholder="Ej: 175">
                    </div>                  
                </div>
            </div>

            <!-- Área de Resultados -->
            <div id="resultado-area" class="mt-4">
                <div class="text-center mb-3">
                    <h3 class="text-white">IMC Calculado: <span id="imc-calculado" class="imc-valor text-primary"></span></h3>
                </div>
                <div class="accordion" id="interpretacionesAcordeon">
                    <!-- Los resultados se insertarán aquí con JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const inputPeso = document.getElementById('peso');
    const inputTalla = document.getElementById('talla');
    const resultadoArea = document.getElementById('resultado-area');
    const imcCalculadoSpan = document.getElementById('imc-calculado');
    const acordeon = document.getElementById('interpretacionesAcordeon');

    function calcularYMostrarResultados() {
        const peso = parseFloat(inputPeso.value);
        const tallaCm = parseFloat(inputTalla.value);

        if (isNaN(peso) || isNaN(tallaCm) || peso <= 0 || tallaCm <= 0) {
            resultadoArea.classList.remove('visible');
            return;
        }

        const tallaM = tallaCm / 100;
        const imc = (peso / (tallaM * tallaM)).toFixed(1);

        imcCalculadoSpan.textContent = imc;
        
        let resultadosHTML = '';
        
        // 1. Interpretación para Adultos
        resultadosHTML += generarInterpretacionAdulto(imc);

        // 2. Interpretación para Niños (ejemplos clave)
        resultadosHTML += generarInterpretacionInfantil(imc, 5, 'Niño de 5 años');
        resultadosHTML += generarInterpretacionInfantil(imc, 10, 'Niño/a de 10 años');
        resultadosHTML += generarInterpretacionInfantil(imc, 15, 'Adolescente de 15 años');

        // 3. Interpretación para Gestantes
        resultadosHTML += generarInterpretacionGestante(imc);

        acordeon.innerHTML = resultadosHTML;

        resultadoArea.classList.add('visible');
    }

    function generarInterpretacionAdulto(imc) {
        let categoria, color, recomendacion;
        if (imc < 18.5) { categoria = 'Bajo Peso'; color = 'info'; } 
        else if (imc < 25) { categoria = 'Peso Normal'; color = 'success'; } 
        else if (imc < 30) { categoria = 'Sobrepeso'; color = 'warning'; } 
        else { categoria = 'Obesidad'; color = 'danger'; }
        recomendacion = 'Clasificación estándar de la OMS para mayores de 20 años.';
        return crearItemAcordeon('Adultos (+20 años)', imc, categoria, color, recomendacion, 'adulto-collapse', true);
    }

    function generarInterpretacionInfantil(imc, edad, titulo) {
        const rangos = { '5': { min: 14, max: 17.5 }, '10': { min: 15, max: 20 }, '15': { min: 17, max: 23 } };
        const rangoNormal = rangos[edad];
        let categoria, color;

        if (imc < rangoNormal.min) { categoria = 'Bajo Peso'; color = 'info'; } 
        else if (imc <= rangoNormal.max) { categoria = 'Peso Normal'; color = 'success'; } 
        else if (imc <= rangoNormal.max + 2) { categoria = 'Sobrepeso'; color = 'warning'; } 
        else { categoria = 'Obesidad'; color = 'danger'; }
        const recomendacion = `Interpretación basada en percentiles de crecimiento para la edad. Rango normal aproximado: ${rangoNormal.min}-${rangoNormal.max}.`;
        return crearItemAcordeon(titulo, imc, categoria, color, recomendacion, `infantil-${edad}-collapse`);
    }

    function generarInterpretacionGestante(imc) {
        let categoria, color, gananciaRecomendada;
        if (imc < 18.5) { categoria = 'Bajo Peso Pregestacional'; color = 'info'; gananciaRecomendada = '12.5 - 18 kg'; } 
        else if (imc < 25) { categoria = 'Peso Normal Pregestacional'; color = 'success'; gananciaRecomendada = '11.5 - 16 kg'; } 
        else if (imc < 30) { categoria = 'Sobrepeso Pregestacional'; color = 'warning'; gananciaRecomendada = '7 - 11.5 kg'; } 
        else { categoria = 'Obesidad Pregestacional'; color = 'danger'; gananciaRecomendada = '5 - 9 kg'; }
        const recomendacion = `Si este IMC corresponde a su estado <strong>pregestacional</strong>, la ganancia de peso recomendada es de <strong>${gananciaRecomendada}</strong>.`;
        return crearItemAcordeon('Gestantes', imc, categoria, color, recomendacion, 'gestante-collapse');
    }

    function crearItemAcordeon(titulo, imc, categoria, color, recomendacion, id, expandido = false) {
        return `
            <div class="accordion-item bg-dark text-white border-secondary">
                <h2 class="accordion-header" id="heading-${id}">
                    <button class="accordion-button ${expandido ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${id}" aria-expanded="${expandido}" aria-controls="${id}">
                        ${titulo} - <span class="ms-2 fw-bold text-${color}">${categoria}</span>
                    </button>
                </h2>
                <div id="${id}" class="accordion-collapse collapse ${expandido ? 'show' : ''}" aria-labelledby="heading-${id}" data-bs-parent="#interpretacionesAcordeon">
                    <div class="accordion-body">
                        ${recomendacion}
                    </div>
                </div>
            </div>
        `;
    }

    inputPeso.addEventListener('input', calcularYMostrarResultados);
    inputTalla.addEventListener('input', calcularYMostrarResultados);
</script>
{% endblock %}
