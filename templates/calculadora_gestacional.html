{% extends "base.html" %}

{% block title %}Calculadora Gestacional y FPP{% endblock %}

{% block head %}
<style>
    /* Animación de aparición suave para los resultados */
    .resultado-area {
        transition: opacity 0.4s ease-in-out;
    }

    /* Estilo para campos con error */
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header bg-dark-accent text-center py-3">
                    <h2 class="card-title mb-0"><i class="fas fa-baby-carriage me-2"></i>Calculadora Gestacional y FPP</h2>
                </div>
                <div class="card-body p-4">
                    
                    <div class="mb-4">
                        <label for="fecha_atencion" class="form-label">Fecha de Atención (o fecha de hoy)</label>
                        <input type="date" class="form-control" id="fecha_atencion">
                    </div>
                    <hr>

                    <!-- OPCIÓN 1: CALCULAR EDAD GESTACIONAL (EG) -->
                    <div class="p-3 border border-secondary rounded mb-4">
                        <h4 class="text-primary">Opción 1: Calcular Edad Gestacional (EG)</h4>
                        <p class="text-muted small">Requiere: FPP y Fecha de Atención.</p>
                        <div class="mb-3">
                            <label for="fpp_input" class="form-label">Fecha Probable de Parto (FPP)</label>
                            <input type="date" class="form-control" id="fpp_input">
                        </div>
                        <div id="resultado-eg" class="resultado-area mt-3 text-center" style="display: none; opacity: 0;">
                            <p class="fs-5">Edad Gestacional: <span class="fw-bold text-success" id="eg-valor"></span></p>
                        </div>
                    </div>

                    <!-- OPCIÓN 2: CALCULAR FECHA PROBABLE DE PARTO (FPP) -->
                    <div class="p-3 border border-secondary rounded">
                        <h4 class="text-primary">Opción 2: Calcular Fecha Probable de Parto (FPP)</h4>
                        <p class="text-muted small">Requiere: Edad Gestacional actual y Fecha de Atención.</p>
                        <div class="mb-3">
                            <label for="eg_input" class="form-label">Edad Gestacional (solo semanas)</label>
                            <input type="number" class="form-control" id="eg_input" placeholder="Ej: 32">
                        </div>
                        <div id="resultado-fpp" class="resultado-area mt-3 text-center" style="display: none; opacity: 0;">
                            <p class="fs-5">Fecha Probable de Parto: <span class="fw-bold text-success" id="fpp-valor"></span></p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- ELEMENTOS COMUNES ---
    const inputFechaAtencion = document.getElementById('fecha_atencion');
    
    // --- ELEMENTOS OPCIÓN 1 (Calcular EG) ---
    const inputFPP1 = document.getElementById('fpp_input');
    const resultadoEG = document.getElementById('resultado-eg');
    const egValor = document.getElementById('eg-valor');

    // --- ELEMENTOS OPCIÓN 2 (Calcular FPP) ---
    const inputEG2 = document.getElementById('eg_input');
    const resultadoFPP = document.getElementById('resultado-fpp');
    const fppValor = document.getElementById('fpp-valor');

    // --- LÓGICA ---

    window.onload = function() {
        const hoy = new Date();
        const hoyFormateado = hoy.toISOString().split('T')[0];
        inputFechaAtencion.value = hoyFormateado;
    };

    function parseDate(dateString) {
        if (!dateString) return null;
        return new Date(dateString + 'T00:00:00');
    }

    // Función para mostrar/ocultar resultados con animación
    function toggleResultado(elemento, mostrar) {
        if (mostrar) {
            elemento.style.display = 'block';
            setTimeout(() => { elemento.style.opacity = '1'; }, 10);
        } else {
            elemento.style.opacity = '0';
            setTimeout(() => { elemento.style.display = 'none'; }, 400);
        }
    }

    // --- LÓGICA DE CÁLCULO MEJORADA ---

    function calcularEG() {
        // Limpia el resultado de la otra calculadora
        toggleResultado(resultadoFPP, false);
        inputEG2.value = ''; // Limpia el campo de la otra opción
        inputEG2.classList.remove('is-invalid');


        const fechaAtencion = parseDate(inputFechaAtencion.value);
        const fpp = parseDate(inputFPP1.value);

        if (!fechaAtencion || !fpp) {
            toggleResultado(resultadoEG, false);
            return;
        }

        const fur = new Date(fpp.getTime());
        fur.setDate(fpp.getDate() - 280);
        const diffTiempo = fechaAtencion.getTime() - fur.getTime();
        const diffDias = Math.floor(diffTiempo / (1000 * 3600 * 24));

        if (diffDias < 0) {
            egValor.innerText = "Fecha inválida.";
        } else {
            const semanas = Math.floor(diffDias / 7);
            const dias = diffDias % 7;
            egValor.innerText = `${semanas} semanas y ${dias} días`;
        }
        toggleResultado(resultadoEG, true);
    }

    function calcularFPP() {
        // Limpia el resultado de la otra calculadora
        toggleResultado(resultadoEG, false);
        inputFPP1.value = ''; // Limpia el campo de la otra opción

        const fechaAtencion = parseDate(inputFechaAtencion.value);
        const semanasEG = parseInt(inputEG2.value, 10);

        // Feedback de error en el campo de semanas
        if (isNaN(semanasEG) || semanasEG < 0 || semanasEG > 42) {
            if (inputEG2.value !== '') {
                inputEG2.classList.add('is-invalid');
            }
            toggleResultado(resultadoFPP, false);
            return;
        } else {
            inputEG2.classList.remove('is-invalid');
        }
        
        if (!fechaAtencion) {
             toggleResultado(resultadoFPP, false);
             return;
        }

        const diasGestacion = semanasEG * 7;
        const fur = new Date(fechaAtencion.getTime());
        fur.setDate(fechaAtencion.getDate() - diasGestacion);
        const fpp = new Date(fur.getTime());
        fpp.setDate(fur.getDate() + 280);

        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        fppValor.innerText = fpp.toLocaleDateString('es-ES', options);
        toggleResultado(resultadoFPP, true);
    }

    // --- "ESCUCHADORES" DE EVENTOS ---
    inputFechaAtencion.addEventListener('change', () => { calcularEG(); calcularFPP(); });
    inputFPP1.addEventListener('change', calcularEG);
    inputEG2.addEventListener('input', calcularFPP);
</script>
{% endblock %}
