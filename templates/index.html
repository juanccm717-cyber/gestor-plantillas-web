<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <style>
        body { display: grid; grid-template-columns: 250px 1fr 350px; gap: 1rem; height: 100vh; margin: 0; }
        header, nav, main, aside { padding: 1rem; }
        nav { border-right: 1px solid #dcdcdc; overflow-y: auto; }
        main { overflow-y: auto; }
        aside { border-left: 1px solid #dcdcdc; overflow-y: auto; background-color: #fdfdfd; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1rem; }
        #plantilla-preview { white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1rem; border-radius: 5px; }
        .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    </style>
</head>
<body>

    <nav>
        <h5>Plantillas Guardadas</h5>
        <div id="lista-registros">Cargando...</div>
    </nav>

    <main>
        <header>
            <h2>Crear Nueva Plantilla</h2>
            <p>Asistente de 4 pasos para la creación de plantillas de atención.</p>
        </header>

        <form id="wizard-form">
            <!-- Paso 1: Código Prestacional y Actividades -->
            <div id="step-1" class="wizard-step active">
                <h4>Paso 1: Código Prestacional y Actividades</h4>
                <label for="codigo_prestacional">Código Prestacional</label>
                <input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción">
                
                <label for="descripcion_prestacional">Descripción Prestacional</label>
                <input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly>

                <label for="actividades_preventivas">Actividades Preventivas</label>
                <textarea id="actividades_preventivas" name="actividades_preventivas" rows="4"></textarea>

                <div class="button-group">
                    <span></span> <!-- Placeholder for alignment -->
                    
                    <!-- CAMBIO: Botón con ID y deshabilitado por defecto -->
                    <button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button>

                </div>
            </div>

            <!-- ... (resto de los pasos 2, 3 y 4 sin cambios ) ... -->
            <div id="step-2" class="wizard-step">
                <h4>Paso 2: Diagnósticos</h4>
                <label for="diagnostico_principal">Diagnóstico Principal (CIE-10)</label>
                <input type="text" id="diagnostico_principal" name="diagnostico_principal" placeholder="Buscar por código o descripción">

                <label for="diagnosticos_complementarios">Diagnósticos Complementarios (CIE-10)</label>
                <textarea id="diagnosticos_complementarios" name="diagnosticos_complementarios" rows="3" placeholder="Buscar y añadir más diagnósticos"></textarea>

                <div class="button-group">
                    <button type="button" class="prev-btn">&laquo; Anterior</button>
                    <button type="button" class="next-btn">Siguiente &raquo;</button>
                </div>
            </div>
            <div id="step-3" class="wizard-step">
                <h4>Paso 3: Medicamentos e Insumos</h4>
                <label for="medicamento_principal">Medicamento Principal</label>
                <input type="text" id="medicamento_principal" name="medicamento_principal">

                <label for="medicamentos_adicionales_obs">Medicamentos Adicionales / Observaciones</label>
                <textarea id="medicamentos_adicionales_obs" name="medicamentos_adicionales_obs" rows="4"></textarea>

                <div class="button-group">
                    <button type="button" class="prev-btn">&laquo; Anterior</button>
                    <button type="button" class="next-btn">Siguiente &raquo;</button>
                </div>
            </div>
            <div id="step-4" class="wizard-step">
                <h4>Paso 4: Procedimientos y Observaciones</h4>
                <label for="procedimiento_principal">Procedimiento Principal</label>
                <input type="text" id="procedimiento_principal" name="procedimiento_principal">

                <label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label>
                <textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea>

                <label for="observaciones">Observaciones Generales</label>
                <textarea id="observaciones" name="observaciones" rows="3"></textarea>

                <div class="button-group">
                    <button type="button" class="prev-btn">&laquo; Anterior</button>
                    <button type="submit" id="save-btn">Guardar Plantilla</button>
                </div>
            </div>
        </form>
    </main>

    <aside>
        <h5>Vista Previa</h5>
        <div id="plantilla-preview">La vista previa aparecerá aquí.</div>
        <button id="copy-btn" style="width: 100%; margin-top: 1rem;">Copiar al Portapapeles</button>
    </aside>

<script>
$(document).ready(function() {
    // ... (código de navegación del wizard sin cambios) ...
    let currentStep = 1;
    const totalSteps = 4;

    function showStep(step) {
        $('.wizard-step').removeClass('active');
        $('#step-' + step).addClass('active');
    }

    $('.next-btn').click(function() {
        if (currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        }
    });

    $('.prev-btn').click(function() {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // --- Autocompletado para Códigos Prestacionales ---
    $('#codigo_prestacional').autocomplete({
        serviceUrl: '/search_codigos',
        paramName: 'query',
        onSelect: function(suggestion) {
            $('#codigo_prestacional').val(suggestion.data.codigo);
            $('#descripcion_prestacional').val(suggestion.data.descripcion);
            
            // CAMBIO: Habilita el botón al seleccionar
            $('#btn-step1-next').prop('disabled', false); 
        },
        // CAMBIO: Nueva función para deshabilitar si la selección es inválida
        onInvalidateSelection: function() {
            $('#descripcion_prestacional').val('');
            $('#btn-step1-next').prop('disabled', true);
        },
        transformResult: function(response) {
            const res = JSON.parse(response);
            return {
                suggestions: $.map(res.suggestions, function(dataItem) {
                    return { value: `(${dataItem.codigo}) ${dataItem.descripcion}`, data: dataItem };
                })
            };
        }
    });

    // CAMBIO: Nuevo evento para deshabilitar si el campo se vacía manualmente
    $('#codigo_prestacional').on('input', function() {
        if ($(this).val().trim() === '') {
            $('#descripcion_prestacional').val('');
            $('#btn-step1-next').prop('disabled', true);
        }
    });

    // ... (resto del script: autocompletado de diagnósticos, guardar, cargar, etc.) ...
    function setupAutocomplete(selector) {
        $(selector).autocomplete({
            serviceUrl: '/search_diagnosticos',
            paramName: 'query',
            onSelect: function(suggestion) {
                $(selector).val(suggestion.data);
            }
        });
    }
    setupAutocomplete('#diagnostico_principal');
    setupAutocomplete('#diagnosticos_complementarios');

    $('#wizard-form').on('submit', function(e) {
        e.preventDefault();
        // ... (código para guardar el formulario)
        const formData = {
            codigo_prestacional: $('#codigo_prestacional').val(),
            descripcion_prestacional: $('#descripcion_prestacional').val(),
            actividades_preventivas: $('#actividades_preventivas').val(),
            diagnostico_principal: $('#diagnostico_principal').val(),
            diagnosticos_complementarios: $('#diagnosticos_complementarios').val(),
            medicamento_principal: $('#medicamento_principal').val(),
            medicamentos_adicionales_obs: $('#medicamentos_adicionales_obs').val(),
            procedimiento_principal: $('#procedimiento_principal').val(),
            procedimientos_adicionales_obs: $('#procedimientos_adicionales_obs').val(),
            observaciones: $('#observaciones').val()
        };

        $.ajax({
            url: '/guardar_plantilla',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                alert(response.message);
                loadRegistros();
                $('#wizard-form')[0].reset();
                currentStep = 1;
                showStep(1);
                // CAMBIO: Resetear el botón a deshabilitado al guardar
                $('#btn-step1-next').prop('disabled', true);
            },
            error: function() {
                alert('Error al guardar la plantilla.');
            }
        });
    });
    
    // ... (código para cargar registros, preview y copiar) ...
    function loadRegistros() {
        $.get('/get_registros', function(registros) {
            const lista = $('#lista-registros');
            lista.empty();
            registros.forEach(function(reg) {
                const item = $(`<article style="margin-bottom: 0.5rem; cursor: pointer;" data-id="${reg.id}"><strong>${reg.codigo_prestacional || 'S/C'}</strong>  
<small>${reg.descripcion_prestacional || 'Sin descripción'}</small></article>`);
                item.click(function() { showPreview($(this).data('id')); });
                lista.append(item);
            });
        });
    }

    function showPreview(id) {
        $.get('/get_registros', function(registros) {
            const registro = registros.find(r => r.id == id);
            if (registro) {
                const previewContent = `
**Código Prestacional:** ${registro.codigo_prestacional || 'No registrado'}
**Descripción:** ${registro.descripcion_prestacional || 'No registrado'}

**Actividades Preventivas:**
${registro.actividades_preventivas || 'No registrado'}

**Diagnóstico Principal:**
${registro.diagnostico_principal || 'No registrado'}

**Diagnósticos Complementarios:**
${registro.diagnosticos_complementarios || 'No registrado'}

**Medicamento Principal:**
${registro.medicamento_principal || 'No registrado'}

**Meds. Adicionales / Obs:**
${registro.medicamentos_adicionales_obs || 'No registrado'}

**Procedimiento Principal:**
${registro.procedimiento_principal || 'No registrado'}

**Procs. Adicionales / Obs:**
${registro.procedimientos_adicionales_obs || 'No registrado'}

**Observaciones Generales:**
${registro.observaciones || 'No registrado'}
                `;
                $('#plantilla-preview').text(previewContent);
            }
        });
    }

    $('#copy-btn').click(function() {
        const textToCopy = $('#plantilla-preview').text();
        navigator.clipboard.writeText(textToCopy).then(function() {
            alert('¡Copiado al portapapeles!');
        }, function(err) {
            alert('Error al copiar: ' + err);
        });
    });

    loadRegistros();
    showStep(currentStep);
});
</script>

</body>
</html>
