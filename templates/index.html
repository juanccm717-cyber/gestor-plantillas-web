<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        /* Estilos generales (sin cambios ) */
        body { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100vh; margin: 0; padding-bottom: 70px; }
        nav, aside { padding: 1rem; overflow-y: auto; display: none; background-color: #f8f9fa; }
        nav { border-right: 1px solid #dcdcdc; }
        aside { border-left: 1px solid #dcdcdc; }
        main { padding: 1rem; overflow-y: auto; }
        body.modo-visualizacion { grid-template-columns: 250px 1fr 350px; }
        footer.page-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9; border-top: 1px solid #e0e0e0; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1rem; }
        #plantilla-preview { white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1rem; border-radius: 5px; min-height: 300px; }
        .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; z-index: 9999; }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
        article small { color: #555; }
        #actividades-checkbox-container { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #fff; }
        #actividades-checkbox-container label { display: block; margin-bottom: 8px; }
        #editor-observaciones { height: 150px; background-color: #fff; }

        /* ====================================================================== */
        /* CORRECCIÓN CSS: Anular estilos de Pico.css dentro del editor Quill.js */
        /* ====================================================================== */
        .ql-toolbar button {
            width: 28px;      /* Ancho por defecto de Quill */
            height: 24px;     /* Alto por defecto de Quill */
            padding: 3px 5px; /* Padding por defecto de Quill */
        }
        .ql-toolbar .ql-picker-label {
            font-size: 14px; /* Restablecer tamaño de fuente para el desplegable de color */
        }
        /* ====================================================================== */

    </style>
</head>
<body>
    <!-- El resto del body (nav, main, aside, footer, form, script) no cambia -->
    <nav>
        <h5>Plantillas Guardadas</h5>
        <div id="lista-registros">Cargando...</div>
    </nav>
    <main>
        <header>
            <h2>Crear Nueva Plantilla</h2>
            <p>Asistente de 4 pasos para la creación de plantillas de atención.</p>
        </header>
        <form id="wizard-form">
            <div id="step-1" class="wizard-step active">
                <h4>Paso 1: Código Prestacional y Actividades</h4>
                <label for="codigo_prestacional">Código Prestacional</label>
                <input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción">
                <label for="descripcion_prestacional">Descripción Prestacional</label>
                <input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly>
                <label>Seleccione las Actividades Preventivas</label>
                <div id="actividades-checkbox-container">
                    <small><i>Seleccione un código prestacional para ver las actividades sugeridas.</i></small>
                </div>
                <div class="button-group"><span></span><button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button></div>
            </div>
            <div id="step-2" class="wizard-step">
                <h4>Paso 2: Diagnósticos</h4>
                <label for="diagnostico_principal">Diagnóstico Principal (CIE-10)</label>
                <input type="text" id="diagnostico_principal" name="diagnostico_principal" placeholder="Buscar por código o descripción">
                <label for="diagnosticos_complementarios">Diagnósticos Complementarios (CIE-10)</label>
                <textarea id="diagnosticos_complementarios" name="diagnosticos_complementarios" rows="3" placeholder="Buscar y añadir más diagnósticos"></textarea>
                <div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div>
            </div>
            <div id="step-3" class="wizard-step">
                <h4>Paso 3: Medicamentos y/o Insumos</h4>
                <label for="medicamento_principal">Medicamento Principal</label>
                <input type="text" id="medicamento_principal" name="medicamento_principal">
                <label for="medicamentos_adicionales_obs">Medicamentos Adicionales / Observaciones</label>
                <textarea id="medicamentos_adicionales_obs" name="medicamentos_adicionales_obs" rows="4"></textarea>
                <div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div>
            </div>
            <div id="step-4" class="wizard-step">
                <h4>Paso 4: Procedimientos y Observaciones</h4>
                <label for="procedimiento_principal">Procedimiento Principal</label>
                <input type="text" id="procedimiento_principal" name="procedimiento_principal">
                <label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label>
                <textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea>
                <label>Observaciones Generales</label>
                <div id="editor-observaciones"></div>
                <div class="button-group">
                    <button type="button" class="prev-btn">&laquo; Anterior</button>
                    <button type="submit" id="save-btn">Guardar Plantilla</button>
                </div>
            </div>
        </form>
    </main>
    <aside>
        <h5>Vista Previa</h5>
        <div id="plantilla-preview">Seleccione una plantilla de la lista para ver su contenido.</div>
        <button id="copy-btn" style="width: 100%; margin-top: 1rem;">Copiar al Portapapeles</button>
    </aside>
    <footer class="page-footer">
        <button id="toggle-panels-btn">Ver Plantillas Guardadas</button>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
    // El código JavaScript no necesita cambios, por lo que se mantiene igual.
    $(document ).ready(function() {
        const userRol = "{{ rol }}";

        const colores = ['#28a745', '#ffc107', '#dc3545'];
        const toolbarOptions = [['bold'], [{ 'color': colores }]];
        const quill = new Quill('#editor-observaciones', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow'
        });

        $('#toggle-panels-btn').click(function() {
            $('body').toggleClass('modo-visualizacion');
            const isVisible = $('body').hasClass('modo-visualizacion');
            $('nav, aside').toggle(isVisible);
            $(this).text(isVisible ? 'Ocultar Paneles y Volver a Crear' : 'Ver Plantillas Guardadas');
        });

        let currentStep = 1;
        const totalSteps = 4;
        function showStep(step) {
            $('.wizard-step').removeClass('active');
            $('#step-' + step).addClass('active');
        }
        $('.next-btn').click(function() { if (currentStep < totalSteps) { currentStep++; showStep(currentStep); } });
        $('.prev-btn').click(function() { if (currentStep > 1) { currentStep--; showStep(currentStep); } });

        function fetchAndFillActivities(codigo) {
            const container = $('#actividades-checkbox-container');
            container.html('<small><i>Cargando actividades...</i></small>');
            $.ajax({
                url: `/get_actividades_por_codigo/${codigo}`,
                dataType: 'json',
                success: function(response) {
                    container.empty();
                    if (response.actividades && response.actividades.length > 0) {
                        response.actividades.forEach(function(actividad) {
                            const label = $('<label></label>');
                            const checkbox = $('<input type="checkbox" name="actividades_preventivas">').val(actividad.descripcion);
                            label.append(checkbox);
                            label.append(` ${actividad.descripcion}`);
                            container.append(label);
                        });
                    } else {
                        container.html('<small><i>No hay actividades sugeridas para este código.</i></small>');
                    }
                },
                error: function() { container.html('<small><i>Error al cargar actividades.</i></small>'); }
            });
        }

        $('#codigo_prestacional').on('input', function() {
            const codigoInput = $(this).val().trim();
            if (codigoInput.length === 3) {
                $.ajax({
                    url: '/search_codigos', data: { query: codigoInput }, dataType: 'json',
                    success: function(response) {
                        const coincidenciaExacta = response.suggestions.find(s => s.codigo === codigoInput);
                        if (coincidenciaExacta) {
                            $('#descripcion_prestacional').val(coincidenciaExacta.descripcion);
                            $('#btn-step1-next').prop('disabled', false);
                            fetchAndFillActivities(codigoInput);
                        } else {
                            $('#descripcion_prestacional').val('Código no encontrado');
                            $('#btn-step1-next').prop('disabled', true);
                        }
                    }
                });
            } else {
                $('#descripcion_prestacional').val('');
                $('#actividades-checkbox-container').html('<small><i>Seleccione un código prestacional...</i></small>');
                $('#btn-step1-next').prop('disabled', true);
            }
        });

        $('#codigo_prestacional').autocomplete({
            serviceUrl: '/search_codigos', paramName: 'query', dataType: 'json', autoSelectFirst: true,
            onSelect: function(suggestion) {
                $('#codigo_prestacional').val(suggestion.data.codigo);
                $('#descripcion_prestacional').val(suggestion.data.descripcion);
                $('#btn-step1-next').prop('disabled', false);
                fetchAndFillActivities(suggestion.data.codigo);
                return false;
            },
            transformResult: function(response) {
                return { suggestions: $.map(response.suggestions, function(dataItem) { return { value: `(${dataItem.codigo}) ${dataItem.descripcion}`, data: dataItem }; }) };
            }
        });

        $('#codigo_prestacional').on('keydown', function(e) {
            if (e.which === 13 || e.which === 9) { $(this).autocomplete('hide'); }
        });

        function loadRegistros() {
            $.get('/get_registros', function(registros) {
                const lista = $('#lista-registros');
                lista.empty();
                registros.forEach(function(reg) {
                    const item = $(`<article style="margin-bottom: 0.5rem; cursor: pointer;" data-id="${reg.id}"><strong>${reg.codigo_prestacional || 'S/C'}</strong>  
<small>${reg.descripcion_prestacional || 'Sin descripción'}</small></article>`);
                    item.click(function() { showPreview($(this).data('id')); });
                    lista.append(item);
                });
            }).fail(function(xhr) {
                if (xhr.status === 401) {
                    alert("Su sesión ha expirado. La página se recargará para que inicie sesión de nuevo.");
                    window.location.reload();
                } else {
                    $('#lista-registros').text('Error al cargar plantillas.');
                }
            });
        }

        function showPreview(id) {
            $.get('/get_registros', function(registros) {
                const registro = registros.find(r => r.id == id);
                if (registro) {
                    const obsHtml = registro.observaciones || '';
                    const obsText = $('<div>').html(obsHtml).text();

                    const previewContent = `**Código Prestacional:** ${registro.codigo_prestacional || 'N/A'}\n**Descripción:** ${registro.descripcion_prestacional || 'N/A'}\n\n**Actividades Preventivas:**\n${registro.actividades_preventivas || 'N/A'}\n\n**Diagnóstico Principal:**\n${registro.diagnostico_principal || 'N/A'}\n\n**Diagnósticos Complementarios:**\n${registro.diagnosticos_complementarios || 'N/A'}\n\n**Medicamento Principal:**\n${registro.medicamento_principal || 'N/A'}\n\n**Meds. Adicionales / Obs:**\n${registro.medicamentos_adicionales_obs || 'N/A'}\n\n**Procedimiento Principal:**\n${registro.procedimiento_principal || 'N/A'}\n**Procs. Adicionales / Obs:**\n${registro.procedimientos_adicionales_obs || 'N/A'}\n\n**Observaciones Generales:**\n${obsText}`;
                    $('#plantilla-preview').text(previewContent);
                }
            });
        }

        $('#copy-btn').click(function() {
            const textToCopy = $('#plantilla-preview').text();
            navigator.clipboard.writeText(textToCopy).then(function() { alert('¡Copiado al portapapeles!'); }, function(err) { alert('Error al copiar: ' + err); });
        });

        $('#wizard-form').on('submit', function(e) {
            e.preventDefault();
            const actividadesSeleccionadas = [];
            $('input[name="actividades_preventivas"]:checked').each(function() {
                actividadesSeleccionadas.push($(this).val());
            });
            const observacionesHtml = quill.root.innerHTML;
            const formData = {
                codigo_prestacional: $('#codigo_prestacional').val(),
                descripcion_prestacional: $('#descripcion_prestacional').val(),
                actividades_preventivas: actividadesSeleccionadas.join('\n'),
                diagnostico_principal: $('#diagnostico_principal').val(),
                diagnosticos_complementarios: $('#diagnosticos_complementarios').val(),
                medicamento_principal: $('#medicamento_principal').val(),
                medicamentos_adicionales_obs: $('#medicamentos_adicionales_obs').val(),
                procedimiento_principal: $('#procedimiento_principal').val(),
                procedimientos_adicionales_obs: $('#procedimientos_adicionales_obs').val(),
                observaciones: observacionesHtml
            };
            $.ajax({
                url: '/guardar_plantilla', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert(response.message);
                    loadRegistros();
                    $('#wizard-form')[0].reset();
                    quill.setText('');
                    $('#actividades-checkbox-container').html('<small><i>Seleccione un código prestacional...</i></small>');
                    currentStep = 1; showStep(1);
                    $('#btn-step1-next').prop('disabled', true);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Error al guardar la plantilla.';
                    alert(errorMsg);
                }
            });
        });

        if (userRol === 'viewer') {
            $('#wizard-form').hide();
            $('#toggle-panels-btn').hide();
            $('body').addClass('modo-visualizacion');
            $('nav, aside').show();
            $('main > header > h2').text('Visualización de Plantillas');
            $('main > header > p').text('Seleccione una plantilla de la lista para ver su contenido y copiarlo.');
        } else {
            showStep(currentStep);
        }

        loadRegistros();
    });
    </script>
</body>
</html>
