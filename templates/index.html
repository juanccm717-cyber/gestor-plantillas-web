<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Head y Style (sin cambios) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { --background-color: #eef0f4; --primary-color: #3d8bfd; --secondary-color: #8a9baf; --text-color: #333; --light-gray: #d1d9e6; --shadow-light: #ffffff; --shadow-dark: #babecc; --border-radius: 12px; }
        body { background-color: var(--background-color ); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text-color); display: grid; grid-template-columns: 1fr; gap: 1.5rem; height: 100vh; margin: 0; padding: 1.5rem; box-sizing: border-box; padding-bottom: 90px; }
        nav, aside { background: var(--background-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); overflow-y: auto; display: none; }
        body.modo-visualizacion { grid-template-columns: 280px 1fr 400px; }
        body.modo-visualizacion nav, body.modo-visualizacion aside { display: block; }
        main { padding: 0; }
        main > header { margin-bottom: 2rem; }
        main > header h2 { font-weight: 700; color: #444; }
        .wizard-step { background: var(--background-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: 7px 7px 15px var(--shadow-dark), -7px -7px 15px var(--shadow-light); display: none; }
        .wizard-step.active { display: block; }
        label { font-weight: 600; margin-bottom: 0.5rem; color: #555; }
        input, textarea, #actividades-checkbox-container, #editor-observaciones { border: none; outline: none; background: var(--background-color); border-radius: var(--border-radius); padding: 1rem; box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); width: 100%; }
        input:focus, textarea:focus { box-shadow: inset 1px 1px 2px var(--shadow-dark), inset -1px -1px 2px var(--shadow-light); }
        input[readonly] { background-color: #e0e2e7; color: #777; }
        button, .button, a[role="button"] { border: none; border-radius: var(--border-radius); background: var(--background-color); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); color: var(--text-color); font-weight: 600; padding: 0.8rem 1.2rem; transition: all 0.2s ease-in-out; text-decoration: none; }
        button:hover, .button:hover, a[role="button"]:hover { box-shadow: 3px 3px 7px var(--shadow-dark), -3px -3px 7px var(--shadow-light); }
        button:active, .button:active, a[role="button"]:active { box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); color: var(--primary-color); }
        button.next-btn, button[type="submit"] { background: var(--primary-color); color: white; }
        button.next-btn:active, button[type="submit"]:active { background: #3578d4; }
        .secondary-action { background-color: var(--secondary-color); color: white; }
        .secondary-action:active { background-color: #788a9e; }
        .button-group { display: flex; justify-content: space-between; margin-top: 2rem; }
        footer.page-footer { background: transparent; border: none; position: fixed; bottom: 0; left: 0; width: 100%; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; gap: 1rem; }
        #editor-observaciones { height: 150px; }
        .ql-toolbar.ql-snow { border: none; border-bottom: 1px solid var(--light-gray); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); background: #e8eaf0; }
        .ql-container.ql-snow { border: none; border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .ql-toolbar button { box-shadow: none; }
        .ql-toolbar button:hover { background-color: #ddd; }
        #plantilla-preview { background: var(--background-color); box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); white-space: pre-wrap; font-family: monospace; padding: 1rem; border-radius: var(--border-radius); min-height: 300px; }
        #lista-registros article { background: var(--background-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; box-shadow: 3px 3px 7px var(--shadow-dark), -3px -3px 7px var(--shadow-light); transition: all 0.2s ease-in-out; }
        #lista-registros article:hover { transform: translateY(-2px); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); }
    </style>
</head>
<body>
    <!-- ====================================================================== -->
    <!-- CORRECCIÓN ESTRUCTURAL: <nav> y <aside> están FUERA de <main> -->
    <!-- ====================================================================== -->
    <nav>
        <h5>Plantillas Guardadas</h5>
        <div id="lista-registros">Cargando...</div>
    </nav>
    <main>
        <header>
            <h2>Crear Nueva Plantilla</h2>
            <p>Asistente de 4 pasos para la creación de plantillas de atención.</p>
        </header>
        <form id="wizard-form">
            <!-- Pasos del 1 al 4 (sin cambios) -->
            <div id="step-1" class="wizard-step active"><h4>Paso 1: Código Prestacional y Actividades</h4><label for="codigo_prestacional">Código Prestacional</label><input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción"><label for="descripcion_prestacional">Descripción Prestacional</label><input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly><label>Seleccione las Actividades Preventivas</label><div id="actividades-checkbox-container"><small><i>Seleccione un código prestacional para ver las actividades sugeridas.</i></small></div><div class="button-group"><span></span><button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button></div></div>
            <div id="step-2" class="wizard-step"><h4>Paso 2: Diagnósticos</h4><label for="diagnostico_principal">Diagnóstico Principal (CIE-10)</label><input type="text" id="diagnostico_principal" name="diagnostico_principal" placeholder="Buscar por código o descripción"><label for="diagnosticos_complementarios">Diagnósticos Complementarios (CIE-10)</label><textarea id="diagnosticos_complementarios" name="diagnosticos_complementarios" rows="3" placeholder="Buscar y añadir más diagnósticos"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-3" class="wizard-step"><h4>Paso 3: Medicamentos y/o Insumos</h4><label for="medicamento_principal">Medicamento Principal</label><input type="text" id="medicamento_principal" name="medicamento_principal"><label for="medicamentos_adicionales_obs">Medicamentos Adicionales / Observaciones</label><textarea id="medicamentos_adicionales_obs" name="medicamentos_adicionales_obs" rows="4"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-4" class="wizard-step"><h4>Paso 4: Procedimientos y Observaciones</h4><label for="procedimiento_principal">Procedimiento Principal</label><input type="text" id="procedimiento_principal" name="procedimiento_principal"><label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label><textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea><label>Observaciones Generales</label><div id="editor-observaciones"></div><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="submit" id="save-btn">Guardar Plantilla</button></div></div>
        </form>
    </main>
    <aside>
        <h5>Vista Previa</h5>
        <div id="plantilla-preview">Seleccione una plantilla de la lista para ver su contenido.</div>
        <button id="copy-btn" style="width: 100%; margin-top: 1rem;">Copiar al Portapapeles</button>
    </aside>
    <!-- ====================================================================== -->
    
    <footer class="page-footer"><a href="{{ url_for('menu') }}" role="button" class="secondary-action">Volver al Menú Principal</a><button id="toggle-panels-btn">Ver Plantillas Guardadas</button></footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
    $(document ).ready(function() {
        // --- INICIALIZACIÓN ---
        const userRol = "{{ rol }}";
        const urlParams = new URLSearchParams(window.location.search);
        const modo = urlParams.get('modo');
        const quill = new Quill('#editor-observaciones', {
            modules: { toolbar: [['bold'], [{ 'color': ['#28a745', '#ffc107', '#dc3545'] }]] },
            theme: 'snow'
        });

        // --- DEFINICIÓN DE FUNCIONES PRINCIPALES ---

        function loadRegistros() {
            $.get('/get_registros', function(registros) {
                const lista = $('#lista-registros');
                lista.empty();
                if (registros && registros.length > 0) {
                    registros.forEach(function(reg) {
                        const item = $(`<article><strong data-id="${reg.id}" style="cursor: pointer;">${reg.codigo_prestacional || 'S/C'}: ${reg.descripcion_prestacional || 'Sin descripción'}</strong></article>`);
                        item.find('strong').click(function() { showPreview($(this).data('id')); });
                        lista.append(item);
                    });
                } else {
                    lista.html('<small><i>No hay plantillas guardadas.</i></small>');
                }
            }).fail(function(xhr) {
                if (xhr.status === 401) { alert("Su sesión ha expirado."); window.location.reload(); } 
                else { $('#lista-registros').text('Error al cargar plantillas.'); }
            });
        }

        function showPreview(id) {
            $.get('/get_registros', function(registros) {
                const registro = registros.find(r => r.id == id);
                if (registro) {
                    const obsHtml = registro.observaciones || '';
                    const obsText = $('<div>').html(obsHtml).text();
                    const previewContent = `**Código Prestacional:** ${registro.codigo_prestacional || 'N/A'}\n**Descripción:** ${registro.descripcion_prestacional || 'N/A'}\n\n**Actividades Preventivas:**\n${registro.actividades_preventivas || 'N/A'}\n\n**Diagnóstico Principal:**\n${registro.diagnostico_principal || 'N/A'}\n\n**Diagnósticos Complementarios:**\n${registro.diagnosticos_complementarios || 'N/A'}\n\n**Medicamento Principal:**\n${registro.medicamento_principal || 'N/A'}\n\n**Meds. Adicionales / Obs:**\n${registro.medicamentos_adicionales_obs || 'N/A'}\n\n**Procedimiento Principal:**\n${registro.procedimiento_principal || 'N/A'}\n**Procs. Adicionales / Obs:**\n${registro.procedimientos_adicionales_obs || 'N/A'}\n\n**Observaciones Generales:**\n${obsText}`;
                    $('#plantilla-preview').text(previewContent);
                }
            });
        }

        function fetchAndFillActivities(codigo) {
            const container = $('#actividades-checkbox-container');
            container.html('<small><i>Cargando actividades...</i></small>');
            $.ajax({
                url: `/get_actividades_por_codigo/${codigo}`,
                dataType: 'json',
                success: function(response) {
                    container.empty();
                    if (response.actividades && response.actividades.length > 0) {
                        response.actividades.forEach(function(actividad) {
                            const label = $('<label></label>');
                            const checkbox = $('<input type="checkbox" name="actividades_preventivas">').val(actividad.descripcion);
                            label.append(checkbox).append(` ${actividad.descripcion}`);
                            container.append(label);
                        });
                    } else { container.html('<small><i>No hay actividades sugeridas.</i></small>'); }
                },
                error: function() { container.html('<small><i>Error al cargar.</i></small>'); }
            });
        }

        // --- LÓGICA DEL ASISTENTE (WIZARD) ---
        let currentStep = 1;
        const totalSteps = 4;
        function showStep(step) {
            $('.wizard-step').removeClass('active');
            $('#step-' + step).addClass('active');
        }
        $('.next-btn').click(function() { if (currentStep < totalSteps) { currentStep++; showStep(currentStep); } });
        $('.prev-btn').click(function() { if (currentStep > 1) { currentStep--; showStep(currentStep); } });

        // --- ASIGNACIÓN DE EVENTOS (EVENT BINDING) ---

        $('#toggle-panels-btn').click(function() {
            const body = $('body');
            body.toggleClass('modo-visualizacion');
            const isVisible = body.hasClass('modo-visualizacion');
            
            // CORRECCIÓN: Solo ocultamos el contenido de creación, no el <main> entero
            $('#wizard-form, main > header').toggle(!isVisible);

            if (isVisible) { loadRegistros(); }
            $(this).text(isVisible ? 'Ocultar y Volver a Crear' : 'Ver Plantillas Guardadas');
        });

        $('#copy-btn').click(function() {
            navigator.clipboard.writeText($('#plantilla-preview').text()).then(() => alert('¡Copiado!'), () => alert('Error al copiar.'));
        });

        $('#codigo_prestacional').on('input', function() {
            const codigoInput = $(this).val().trim();
            if (codigoInput.length === 3) {
                $.ajax({
                    url: '/search_codigos', data: { query: codigoInput }, dataType: 'json',
                    success: function(response) {
                        const coincidenciaExacta = response.suggestions.find(s => s.codigo === codigoInput);
                        if (coincidenciaExacta) {
                            $('#descripcion_prestacional').val(coincidenciaExacta.descripcion);
                            $('#btn-step1-next').prop('disabled', false);
                            fetchAndFillActivities(codigoInput);
                        } else {
                            $('#descripcion_prestacional').val('Código no encontrado');
                            $('#btn-step1-next').prop('disabled', true);
                        }
                    }
                });
            } else {
                $('#descripcion_prestacional').val('');
                $('#actividades-checkbox-container').html('<small><i>Seleccione un código...</i></small>');
                $('#btn-step1-next').prop('disabled', true);
            }
        });

        $('#codigo_prestacional').autocomplete({
            serviceUrl: '/search_codigos', paramName: 'query', dataType: 'json', autoSelectFirst: true,
            onSelect: function(suggestion) {
                $('#codigo_prestacional').val(suggestion.data.codigo);
                $('#descripcion_prestacional').val(suggestion.data.descripcion);
                $('#btn-step1-next').prop('disabled', false);
                fetchAndFillActivities(suggestion.data.codigo);
                return false;
            },
            transformResult: function(response) {
                return { suggestions: $.map(response.suggestions, function(dataItem) { return { value: `(${dataItem.codigo}) ${dataItem.descripcion}`, data: dataItem }; }) };
            }
        });
        
        $('#codigo_prestacional').on('keydown', function(e) { if (e.which === 13 || e.which === 9) $(this).autocomplete('hide'); });

        $('#wizard-form').on('submit', function(e) {
            e.preventDefault();
            const formData = {
                codigo_prestacional: $('#codigo_prestacional').val(),
                descripcion_prestacional: $('#descripcion_prestacional').val(),
                actividades_preventivas: $('input[name="actividades_preventivas"]:checked').map(function() { return $(this).val(); }).get().join('\n'),
                diagnostico_principal: $('#diagnostico_principal').val(),
                diagnosticos_complementarios: $('#diagnosticos_complementarios').val(),
                medicamento_principal: $('#medicamento_principal').val(),
                medicamentos_adicionales_obs: $('#medicamentos_adicionales_obs').val(),
                procedimiento_principal: $('#procedimiento_principal').val(),
                procedimientos_adicionales_obs: $('#procedimientos_adicionales_obs').val(),
                observaciones: quill.root.innerHTML
            };
            $.ajax({
                url: '/guardar_plantilla', type: 'POST', contentType: 'application/json', data: JSON.stringify(formData),
                success: function(response) {
                    alert(response.message);
                    loadRegistros();
                    $('#wizard-form')[0].reset();
                    quill.setText('');
                    $('#actividades-checkbox-container').html('<small><i>Seleccione un código...</i></small>');
                    showStep(1);
                    $('#btn-step1-next').prop('disabled', true);
                },
                error: function(xhr) { alert(xhr.responseJSON ? xhr.responseJSON.message : 'Error al guardar.'); }
            });
        });

        // --- LÓGICA DE INICIALIZACIÓN DE LA PÁGINA ---
        if (modo === 'ver') {
            $('#wizard-form, main > header').hide();
            if (userRol !== 'admin') { $('#toggle-panels-btn').hide(); } 
            else { $('#toggle-panels-btn').text('Ocultar y Volver a Crear'); }
            $('body').addClass('modo-visualizacion');
            loadRegistros();
        } else if (userRol === 'viewer') {
            $('#wizard-form, main > header, #toggle-panels-btn').hide();
            $('body').addClass('modo-visualizacion');
            loadRegistros();
        } else {
            showStep(currentStep);
        }
    });
    </script>
</body>
</html>
