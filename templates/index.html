<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { --background-color: #eef0f4; --primary-color: #3d8bfd; --secondary-color: #8a9baf; --text-color: #333; --light-gray: #d1d9e6; --shadow-light: #ffffff; --shadow-dark: #babecc; --border-radius: 12px; }
        body { background-color: var(--background-color ); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text-color); display: grid; grid-template-columns: 1fr; gap: 1.5rem; height: 100vh; margin: 0; padding: 1.5rem; box-sizing: border-box; padding-bottom: 90px; }
        nav, aside { background: var(--background-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); overflow-y: auto; display: none; }
        body.modo-visualizacion { grid-template-columns: 300px 1fr 400px; }
        body.modo-visualizacion nav, body.modo-visualizacion aside { display: block; }
        main { padding: 0; }
        main > header { margin-bottom: 2rem; }
        main > header h2 { font-weight: 700; color: #444; }
        .wizard-step { background: var(--background-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: 7px 7px 15px var(--shadow-dark), -7px -7px 15px var(--shadow-light); display: none; }
        .wizard-step.active { display: block; }
        label { font-weight: 600; margin-bottom: 0.5rem; color: #555; }
        input, textarea, #actividades-checkbox-container, #editor-observaciones { border: none; outline: none; background: var(--background-color); border-radius: var(--border-radius); padding: 1rem; box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); width: 100%; }
        input:focus, textarea:focus { box-shadow: inset 1px 1px 2px var(--shadow-dark), inset -1px -1px 2px var(--shadow-light); }
        input[readonly] { background-color: #e0e2e7; color: #777; }
        button, .button, a[role="button"] { border: none; border-radius: var(--border-radius); background: var(--background-color); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); color: var(--text-color); font-weight: 600; padding: 0.8rem 1.2rem; transition: all 0.2s ease-in-out; text-decoration: none; }
        button:hover, .button:hover, a[role="button"]:hover { box-shadow: 3px 3px 7px var(--shadow-dark), -3px -3px 7px var(--shadow-light); }
        button:active, .button:active, a[role="button"]:active { box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); color: var(--primary-color); }
        button.next-btn, button[type="submit"] { background: var(--primary-color); color: white; }
        button.next-btn:active, button[type="submit"]:active { background: #3578d4; }
        .secondary-action { background-color: var(--secondary-color); color: white; }
        .secondary-action:active { background-color: #788a9e; }
        .button-group { display: flex; justify-content: space-between; margin-top: 2rem; }
        footer.page-footer { background: transparent; border: none; position: fixed; bottom: 0; left: 0; width: 100%; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; gap: 1rem; }
        #editor-observaciones { height: 150px; }
        .ql-toolbar.ql-snow { border: none; border-bottom: 1px solid var(--light-gray); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); background: #e8eaf0; }
        .ql-container.ql-snow { border: none; border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .ql-toolbar button { box-shadow: none; }
        .ql-toolbar button:hover { background-color: #ddd; }
        #plantilla-preview { background: var(--background-color); box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light); white-space: pre-wrap; font-family: monospace; padding: 1rem; border-radius: var(--border-radius); min-height: 300px; }
        #lista-registros article { background: var(--background-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; box-shadow: 3px 3px 7px var(--shadow-dark), -3px -3px 7px var(--shadow-light); transition: all 0.2s ease-in-out; }
        #lista-registros article:hover { transform: translateY(-2px); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); }
    </style>
</head>
<body>
    <nav>
        <h5>Plantillas Guardadas</h5>
        <div id="lista-registros">Cargando...</div>
    </nav>
    <main>
        <header>
            <h2>Crear Nueva Plantilla</h2>
            <p>Asistente de 4 pasos para la creación de plantillas de atención.</p>
        </header>
        <form id="wizard-form">
            <div id="step-1" class="wizard-step active"><h4>Paso 1: Código Prestacional y Actividades</h4><label for="codigo_prestacional">Código Prestacional</label><input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción"><label for="descripcion_prestacional">Descripción Prestacional</label><input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly><label>Seleccione las Actividades Preventivas</label><div id="actividades-checkbox-container"><small><i>Seleccione un código prestacional para ver las actividades sugeridas.</i></small></div><div class="button-group"><span></span><button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button></div></div>
            <div id="step-2" class="wizard-step"><h4>Paso 2: Diagnósticos</h4><label for="diagnostico_principal">Diagnóstico Principal (CIE-10)</label><input type="text" id="diagnostico_principal" name="diagnostico_principal" placeholder="Buscar por código o descripción"><label for="diagnosticos_complementarios">Diagnósticos Complementarios (CIE-10)</label><textarea id="diagnosticos_complementarios" name="diagnosticos_complementarios" rows="3" placeholder="Buscar y añadir más diagnósticos"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-3" class="wizard-step"><h4>Paso 3: Medicamentos y/o Insumos</h4><label for="medicamento_principal">Medicamento Principal</label><input type="text" id="medicamento_principal" name="medicamento_principal"><label for="medicamentos_adicionales_obs">Medicamentos Adicionales / Observaciones</label><textarea id="medicamentos_adicionales_obs" name="medicamentos_adicionales_obs" rows="4"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-4" class="wizard-step"><h4>Paso 4: Procedimientos y Observaciones</h4><label for="procedimiento_principal">Procedimiento Principal</label><input type="text" id="procedimiento_principal" name="procedimiento_principal"><label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label><textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea><label>Observaciones Generales</label><div id="editor-observaciones"></div><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="submit" id="save-btn">Guardar Plantilla</button></div></div>
        </form>
    </main>
    <aside>
        <h5>Vista Previa</h5>
        <div id="plantilla-preview">Seleccione una plantilla de la lista para ver su contenido.</div>
        <button id="copy-btn" style="width: 100%; margin-top: 1rem;">Copiar al Portapapeles</button>
    </aside>
    
    <footer class="page-footer"><a href="{{ url_for('menu') }}" role="button" class="secondary-action">Volver al Menú Principal</a><button id="toggle-panels-btn">Ver Plantillas</button></footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- El HTML de index.html no cambia mucho, solo el script -->
<!-- ... (pega aquí todo el HTML de tu index.html actual, desde <!DOCTYPE html> hasta justo antes de <script>) ... -->

<script>
    // SDK de Supabase
    const supabase_url = 'https://ylzpvpgcelbsbdcauqzw.supabase.co';
    const supabase_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsemp2cGdjZWxic2JkY2F1cXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTg0MDM4NjcsImV4cCI6MjAzMzk3OTg2N30.KjB2xO6-2s_s3s_jY8c_Z8e_Y3e_X2e_T1r_S5f_R4c'; // Reemplaza con tu Anon Key
    const supabase = supabase.createClient(supabase_url, supabase_key );

    let session = null;

    // Función para obtener la sesión y el token
    async function getSessionData() {
        if (session) return session;
        const sessionString = localStorage.getItem('supabase.session');
        if (!sessionString) {
            window.location.href = '/'; // Redirigir al login si no hay sesión
            return null;
        }
        session = JSON.parse(sessionString);
        return session;
    }

    // Modificamos $.ajax para que siempre incluya el token
    $.ajaxSetup({
        beforeSend: async function(xhr) {
            const sessionData = await getSessionData();
            if (sessionData) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + sessionData.access_token);
            }
        }
    });

    // El resto de tu código jQuery...
    $(document).ready(async function() {
        const sessionData = await getSessionData();
        if (!sessionData) return; // Detener si no hay sesión

        const userRole = sessionData.user.user_metadata.rol || 'viewer';
        
        // El resto de tu lógica de $(document).ready...
        // ...
    });

    // Tu función loadRegistros() y otras funciones no necesitan cambiar,
    // porque $.ajaxSetup ya se encarga de añadir el token a todas las peticiones.
</script>

</body>
</html>
