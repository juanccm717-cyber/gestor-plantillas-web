<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <style>
        /* ... (Estilos CSS sin cambios significativos, pero los incluyo para que sea completo ) ... */
        body { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100vh; margin: 0; padding-bottom: 70px; }
        nav, aside { padding: 1rem; overflow-y: auto; display: none; background-color: #f8f9fa; }
        nav { border-right: 1px solid #dcdcdc; }
        aside { border-left: 1px solid #dcdcdc; }
        main { padding: 1rem; overflow-y: auto; }
        body.modo-visualizacion { grid-template-columns: 250px 1fr 350px; }
        footer.page-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9; border-top: 1px solid #e0e0e0; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1rem; }
        #plantilla-preview { white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1rem; border-radius: 5px; min-height: 300px; }
        .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; z-index: 9999; }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
        
        /* NUEVOS ESTILOS PARA LOS CHECKBOXES */
        #actividades-checkbox-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
        }
        #actividades-checkbox-container label {
            display: block; /* Cada checkbox en su propia línea */
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- ... (El HTML del body, nav, main, aside y footer no cambia) ... -->
    <nav><h5>Plantillas Guardadas</h5><div id="lista-registros">Cargando...</div></nav>
    <main>
        <header><h2>Crear Nueva Plantilla</h2><p>Asistente de 4 pasos para la creación de plantillas de atención.</p></header>
        <form id="wizard-form">
            <div id="step-1" class="wizard-step active">
                <h4>Paso 1: Código Prestacional y Actividades</h4>
                <label for="codigo_prestacional">Código Prestacional</label>
                <input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción">
                <label for="descripcion_prestacional">Descripción Prestacional</label>
                <input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly>
                
                <!-- CAMBIO: De textarea a div contenedor de checkboxes -->
                <label for="actividades-checkbox-container">Seleccione las Actividades Preventivas</label>
                <div id="actividades-checkbox-container">
                    <small><i>Seleccione un código prestacional para ver las actividades sugeridas.</i></small>
                </div>

                <div class="button-group"><span></span><button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button></div>
            </div>
            <!-- ... (El resto de los pasos del wizard no cambian) ... -->
        </form>
    </main>
    <aside><h5>Vista Previa</h5><div id="plantilla-preview">...</div><button id="copy-btn">Copiar</button></aside>
    <footer class="page-footer"><button id="toggle-panels-btn">Ver Plantillas Guardadas</button></footer>

    <script>
    $(document).ready(function() {
        const userRol = "{{ rol }}";

        // --- Lógica de UI (sin cambios) ---
        // ...

        // =========================================================================
        // FUNCIÓN CLAVE MODIFICADA: Ahora genera checkboxes
        // =========================================================================
        function fetchAndFillActivities(codigo) {
            const container = $('#actividades-checkbox-container');
            container.html('<small><i>Cargando actividades...</i></small>'); // Mensaje de carga

            $.ajax({
                url: `/get_actividades_por_codigo/${codigo}`,
                dataType: 'json',
                success: function(response) {
                    container.empty(); // Limpiar el contenedor
                    if (response.actividades && response.actividades.length > 0) {
                        response.actividades.forEach(function(actividad) {
                            // Crear un label y un input checkbox para cada actividad
                            const label = $('<label></label>');
                            const checkbox = $('<input type="checkbox" name="actividades_preventivas">')
                                .val(actividad.descripcion); // El valor es la descripción completa
                            
                            label.append(checkbox);
                            label.append(` ${actividad.descripcion}`); // Añadir el texto al lado
                            container.append(label);
                        });
                    } else {
                        container.html('<small><i>No hay actividades sugeridas para este código.</i></small>');
                    }
                },
                error: function() {
                    container.html('<small><i>Error al cargar actividades.</i></small>');
                }
            });
        }

        // --- Lógica de Autocompletado (sin cambios en su mayoría) ---
        // ... (La lógica de $('#codigo_prestacional').on('input', ...) y .autocomplete(...) es la misma)
        // La única diferencia es que llama a la nueva fetchAndFillActivities
        
        // =========================================================================
        // CAMBIO CLAVE AL GUARDAR: Ahora recopila desde los checkboxes
        // =========================================================================
        $('#wizard-form').on('submit', function(e) {
            e.preventDefault();

            // Recopilar las actividades seleccionadas
            const actividadesSeleccionadas = [];
            $('input[name="actividades_preventivas"]:checked').each(function() {
                actividadesSeleccionadas.push($(this).val());
            });

            const formData = {
                codigo_prestacional: $('#codigo_prestacional').val(),
                descripcion_prestacional: $('#descripcion_prestacional').val(),
                actividades_preventivas: actividadesSeleccionadas.join('\n'), // Las unimos con salto de línea
                diagnostico_principal: $('#diagnostico_principal').val(),
                diagnosticos_complementarios: $('#diagnosticos_complementarios').val(),
                medicamento_principal: $('#medicamento_principal').val(),
                medicamentos_adicionales_obs: $('#medicamentos_adicionales_obs').val(),
                procedimiento_principal: $('#procedimiento_principal').val(),
                procedimientos_adicionales_obs: $('#procedimientos_adicionales_obs').val(),
                observaciones: $('#observaciones').val()
            };

            $.ajax({
                url: '/guardar_plantilla',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert(response.message);
                    loadRegistros();
                    // Resetear el formulario (incluyendo limpiar checkboxes)
                    $('#wizard-form')[0].reset();
                    $('#actividades-checkbox-container').html('<small><i>Seleccione un código prestacional...</i></small>');
                    currentStep = 1; showStep(1);
                    $('#btn-step1-next').prop('disabled', true);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Error al guardar la plantilla.';
                    alert(errorMsg);
                }
            });
        });

        // --- Control de UI basado en el Rol (sin cambios) ---
        // ...

        // Carga inicial
        loadRegistros();
        if (userRol === 'admin') {
            showStep(currentStep);
        }
    });
    </script>
</body>
</html>
