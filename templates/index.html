<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    
    <!-- Estilos de Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <!-- ===================== NUEVO: Estilos de Quill.js ===================== -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- ====================================================================== -->

    <style>
        /* ... (Todos los estilos anteriores sin cambios ) ... */
        body { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100vh; margin: 0; padding-bottom: 70px; }
        nav, aside { padding: 1rem; overflow-y: auto; display: none; background-color: #f8f9fa; }
        nav { border-right: 1px solid #dcdcdc; }
        aside { border-left: 1px solid #dcdcdc; }
        main { padding: 1rem; overflow-y: auto; }
        body.modo-visualizacion { grid-template-columns: 250px 1fr 350px; }
        footer.page-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9; border-top: 1px solid #e0e0e0; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1rem; }
        #plantilla-preview { white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1rem; border-radius: 5px; min-height: 300px; }
        .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; z-index: 9999; }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
        article small { color: #555; }
        #actividades-checkbox-container { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #fff; }
        #actividades-checkbox-container label { display: block; margin-bottom: 8px; }

        /* ===================== NUEVO: Estilos para el editor Quill ===================== */
        #editor-observaciones {
            height: 150px; /* Altura del área de edición */
            background-color: #fff;
        }
        /* =========================================================================== */
    </style>
</head>
<body>
    <!-- ... (nav, main, aside, footer sin cambios) ... -->
    <nav><h5>Plantillas Guardadas</h5><div id="lista-registros">Cargando...</div></nav>
    <main>
        <header><h2>Crear Nueva Plantilla</h2><p>Asistente de 4 pasos para la creación de plantillas de atención.</p></header>
        <form id="wizard-form">
            <!-- Pasos 1, 2 y 3 sin cambios -->
            <div id="step-1" class="wizard-step active">...</div>
            <div id="step-2" class="wizard-step">...</div>
            <div id="step-3" class="wizard-step">...</div>

            <div id="step-4" class="wizard-step">
                <h4>Paso 4: Procedimientos y Observaciones</h4>
                <label for="procedimiento_principal">Procedimiento Principal</label>
                <input type="text" id="procedimiento_principal" name="procedimiento_principal">
                <label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label>
                <textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea>
                
                <!-- ===================== CAMBIO: De textarea a div para Quill ===================== -->
                <label>Observaciones Generales</label>
                <div id="editor-observaciones"></div>
                <!-- ================================================================================= -->

                <div class="button-group">
                    <button type="button" class="prev-btn">&laquo; Anterior</button>
                    <button type="submit" id="save-btn">Guardar Plantilla</button>
                </div>
            </div>
        </form>
    </main>
    <aside><h5>Vista Previa</h5><div id="plantilla-preview">...</div><button id="copy-btn">...</button></aside>
    <footer class="page-footer"><button id="toggle-panels-btn">...</button></footer>

    <!-- Scripts de jQuery y Autocomplete (sin cambios) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    
    <!-- ===================== NUEVO: Script de Quill.js ===================== -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- =================================================================== -->

    <script>
    $(document ).ready(function() {
        const userRol = "{{ rol }}";

        // ===================== NUEVO: Inicialización de Quill.js =====================
        // Definimos los colores que queremos
        const colores = ['#28a745', '#ffc107', '#dc3545']; // Verde, Amarillo, Rojo

        const toolbarOptions = [
            ['bold'], // Botón de negrita
            [{ 'color': colores }] // Botón desplegable con nuestros colores
        ];

        const quill = new Quill('#editor-observaciones', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow' // Tema estándar con barra de herramientas
        });
        // =============================================================================

        // ... (Toda la lógica de UI, autocompletado, etc., sin cambios) ...
        function loadRegistros() { /* ... */ }
        function showPreview(id) { /* ... */ }
        // ...

        $('#wizard-form').on('submit', function(e) {
            e.preventDefault();
            
            // ... (actividadesSeleccionadas sin cambios) ...
            const actividadesSeleccionadas = [];
            $('input[name="actividades_preventivas"]:checked').each(function() {
                actividadesSeleccionadas.push($(this).val());
            });

            // ===================== CAMBIO: Obtener contenido del editor Quill =====================
            // Usamos .innerHTML para obtener el contenido como HTML
            const observacionesHtml = quill.root.innerHTML;
            // ======================================================================================

            const formData = {
                codigo_prestacional: $('#codigo_prestacional').val(),
                descripcion_prestacional: $('#descripcion_prestacional').val(),
                actividades_preventivas: actividadesSeleccionadas.join('\n'),
                diagnostico_principal: $('#diagnostico_principal').val(),
                diagnosticos_complementarios: $('#diagnosticos_complementarios').val(),
                medicamento_principal: $('#medicamento_principal').val(),
                medicamentos_adicionales_obs: $('#medicamentos_adicionales_obs').val(),
                procedimiento_principal: $('#procedimiento_principal').val(),
                procedimientos_adicionales_obs: $('#procedimientos_adicionales_obs').val(),
                // Guardamos el contenido HTML en el campo de observaciones
                observaciones: observacionesHtml
            };

            $.ajax({
                url: '/guardar_plantilla',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert(response.message);
                    loadRegistros();
                    $('#wizard-form')[0].reset();
                    
                    // Limpiar el editor Quill
                    quill.setText('');

                    $('#actividades-checkbox-container').html('<small><i>Seleccione un código prestacional...</i></small>');
                    currentStep = 1; showStep(1);
                    $('#btn-step1-next').prop('disabled', true);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Error al guardar la plantilla.';
                    alert(errorMsg);
                }
            });
        });

        // ... (Lógica de roles y carga inicial sin cambios) ...
    });
    </script>
</body>
</html>
