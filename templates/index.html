<!DOCTYPE html>
<!-- ... (todo el head y el body hasta el script) ... -->
<script>
$(document).ready(function() {
    // ... (toda la lógica de botones y wizard) ...

    // --- Lógica Automática para Códigos Prestacionales (VERSIÓN FINAL) ---
    $('#codigo_prestacional').on('input', function() {
        const codigoInput = $(this).val().trim();
        if (codigoInput.length === 3) {
            $.ajax({
                url: '/search_codigos',
                data: { query: codigoInput },
                dataType: 'json', // Le decimos a jQuery que esperamos un JSON
                success: function(response) { // 'response' ya será un objeto, no un texto
                    const coincidenciaExacta = response.suggestions.find(s => s.codigo === codigoInput);
                    if (coincidenciaExacta) {
                        $('#descripcion_prestacional').val(coincidenciaExacta.descripcion);
                        $('#btn-step1-next').prop('disabled', false);
                    } else {
                        $('#descripcion_prestacional').val('Código no encontrado');
                        $('#btn-step1-next').prop('disabled', true);
                    }
                }
            });
        } else if (codigoInput.length < 3) {
            $('#descripcion_prestacional').val('');
            $('#btn-step1-next').prop('disabled', true);
        }
    });

    $('#codigo_prestacional').autocomplete({
        serviceUrl: '/search_codigos',
        paramName: 'query',
        dataType: 'json', // Le decimos a jQuery que esperamos un JSON
        autoSelectFirst: true,
        onSelect: function(suggestion) {
            $('#codigo_prestacional').val(suggestion.data.codigo);
            $('#descripcion_prestacional').val(suggestion.data.descripcion);
            $('#btn-step1-next').prop('disabled', false);
            return false; 
        },
        onInvalidateSelection: function() {
            if ($('#codigo_prestacional').val().length !== 3) {
                 $('#descripcion_prestacional').val('');
                 $('#btn-step1-next').prop('disabled', true);
            }
        },
        transformResult: function(response) { // 'response' ya es un objeto
            return {
                suggestions: $.map(response.suggestions, function(dataItem) {
                    return { value: `(${dataItem.codigo}) ${dataItem.descripcion}`, data: dataItem };
                })
            };
        }
    });

    // ... (resto del script sin cambios) ...
});
</script>
</body>
</html>
