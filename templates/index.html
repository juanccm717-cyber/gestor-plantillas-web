<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Plantillas Médicas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <style>
        body { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100vh; margin: 0; padding-bottom: 70px; }
        nav, aside { padding: 1rem; overflow-y: auto; display: none; }
        nav { border-right: 1px solid #dcdcdc; }
        aside { border-left: 1px solid #dcdcdc; background-color: #fdfdfd; }
        main { padding: 1rem; overflow-y: auto; }
        body.modo-visualizacion { grid-template-columns: 250px 1fr 350px; }
        footer.page-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9; border-top: 1px solid #e0e0e0; padding: 1rem; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1rem; }
        #plantilla-preview { white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1rem; border-radius: 5px; }
        .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; z-index: 9999; }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    </style>
</head>
<body>
    <nav><h5>Plantillas Guardadas</h5><div id="lista-registros">Cargando...</div></nav>
    <main>
        <header><h2>Crear Nueva Plantilla</h2><p>Asistente de 4 pasos para la creación de plantillas de atención.</p></header>
        <form id="wizard-form">
            <div id="step-1" class="wizard-step active">
                <h4>Paso 1: Código Prestacional y Actividades</h4>
                <label for="codigo_prestacional">Código Prestacional</label>
                <input type="text" id="codigo_prestacional" name="codigo_prestacional" placeholder="Escriba el código o descripción">
                <label for="descripcion_prestacional">Descripción Prestacional</label>
                <input type="text" id="descripcion_prestacional" name="descripcion_prestacional" readonly>
                <label for="actividades_preventivas">Actividades Preventivas Sugeridas</label>
                <textarea id="actividades_preventivas" name="actividades_preventivas" rows="5"></textarea>
                <div class="button-group"><span></span><button type="button" class="next-btn" id="btn-step1-next" disabled>Siguiente &raquo;</button></div>
            </div>
            <!-- Resto de los pasos -->
            <div id="step-2" class="wizard-step"><h4>Paso 2: Diagnósticos</h4><label for="diagnostico_principal">Diagnóstico Principal (CIE-10 )</label><input type="text" id="diagnostico_principal" name="diagnostico_principal" placeholder="Buscar por código o descripción"><label for="diagnosticos_complementarios">Diagnósticos Complementarios (CIE-10)</label><textarea id="diagnosticos_complementarios" name="diagnosticos_complementarios" rows="3" placeholder="Buscar y añadir más diagnósticos"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-3" class="wizard-step"><h4>Paso 3: Medicamentos e Insumos</h4><label for="medicamento_principal">Medicamento Principal</label><input type="text" id="medicamento_principal" name="medicamento_principal"><label for="medicamentos_adicionales_obs">Medicamentos Adicionales / Observaciones</label><textarea id="medicamentos_adicionales_obs" name="medicamentos_adicionales_obs" rows="4"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="button" class="next-btn">Siguiente &raquo;</button></div></div>
            <div id="step-4" class="wizard-step"><h4>Paso 4: Procedimientos y Observaciones</h4><label for="procedimiento_principal">Procedimiento Principal</label><input type="text" id="procedimiento_principal" name="procedimiento_principal"><label for="procedimientos_adicionales_obs">Procedimientos Adicionales / Observaciones</label><textarea id="procedimientos_adicionales_obs" name="procedimientos_adicionales_obs" rows="4"></textarea><label for="observaciones">Observaciones Generales</label><textarea id="observaciones" name="observaciones" rows="3"></textarea><div class="button-group"><button type="button" class="prev-btn">&laquo; Anterior</button><button type="submit" id="save-btn">Guardar Plantilla</button></div></div>
        </form>
    </main>
    <aside><h5>Vista Previa</h5><div id="plantilla-preview">Seleccione una plantilla de la lista para ver su contenido.</div><button id="copy-btn" style="width: 100%; margin-top: 1rem;">Copiar al Portapapeles</button></aside>
    <footer class="page-footer"><button id="toggle-panels-btn">Ver Plantillas Guardadas</button></footer>

    <script>
    $(document).ready(function() {
        // --- Lógica de UI (botones, wizard) ---
        $('#toggle-panels-btn').click(function() {
            $('body').toggleClass('modo-visualizacion');
            const isVisible = $('body').hasClass('modo-visualizacion');
            $('nav, aside').toggle(isVisible);
            $(this).text(isVisible ? 'Ocultar Paneles y Volver a Crear' : 'Ver Plantillas Guardadas');
        });
        let currentStep = 1; const totalSteps = 4;
        function showStep(step) { $('.wizard-step').removeClass('active'); $('#step-' + step).addClass('active'); }
        $('.next-btn').click(function() { if (currentStep < totalSteps) { currentStep++; showStep(currentStep); } });
        $('.prev-btn').click(function() { if (currentStep > 1) { currentStep--; showStep(currentStep); } });

        // --- Lógica de Autocompletado y Actividades ---
        function fetchAndFillActivities(codigo) {
             $.ajax({
                url: `/get_actividades_por_codigo/${codigo}`,
                dataType: 'json',
                success: function(response) {
                    const textoActividades = (response.actividades && response.actividades.length > 0)
                        ? response.actividades.join('\n')
                        : '';
                    $('#actividades_preventivas').val(textoActividades).trigger('input'); // Trigger para actualizar vista previa si existe
                }
            });
        }

        $('#codigo_prestacional').on('input', function() {
            const codigoInput = $(this).val().trim();
            if (codigoInput.length === 3) { fetchAndFillActivities(codigoInput); }
            else if (codigoInput.length < 3) {
                $('#descripcion_prestacional').val('');
                $('#actividades_preventivas').val('');
                $('#btn-step1-next').prop('disabled', true);
            }
        });

        $('#codigo_prestacional').autocomplete({
            serviceUrl: '/search_codigos', paramName: 'query', dataType: 'json', autoSelectFirst: true,
            onSelect: function(suggestion) {
                $('#codigo_prestacional').val(suggestion.data.codigo);
                $('#descripcion_prestacional').val(suggestion.data.descripcion);
                $('#btn-step1-next').prop('disabled', false);
                fetchAndFillActivities(suggestion.data.codigo);
                return false; 
            },
            transformResult: function(response) {
                return { suggestions: $.map(response.suggestions, function(dataItem) { return { value: `(${dataItem.codigo}) ${dataItem.descripcion}`, data: dataItem }; }) };
            }
        });

        $('#codigo_prestacional').on('keydown', function(e) {
            if (e.which === 13 || e.which === 9) { $(this).autocomplete('hide'); }
        });

        // --- Carga y guardado de datos ---
        // (El resto del script para guardar, cargar, etc. no cambia)
        // ...
    });
    </script>
</body>
</html>
